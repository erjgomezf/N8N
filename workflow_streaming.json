{
  "name": "streaming",
  "nodes": [
    {
      "parameters": {
        "multipleMethods": true,
        "path": "streaming-service",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1440,
        576
      ],
      "id": "44851bcb-47df-4972-8f71-ed7276776be0",
      "name": "Webhook",
      "webhookId": "37203fb3-dfd4-43a1-9b58-166d28576770"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <script>\n        window.WEBHOOK_URL = '{{ $('Configuracion').item.json.webhook_url }}/webhook/streaming-service';\n    </script>\n    <title>Solicitud de Servicio - Streaming Profesional</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n            background-color: #1a1a1a;\n            color: #fff;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            /* Imagen de fondo din√°mica por defecto */\n            background-image: url('https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&q=80');\n            background-size: cover;\n            background-position: center;\n            background-attachment: fixed;\n            transition: background-image 0.5s ease-in-out;\n        }\n\n        /* Overlay oscuro para mejorar legibilidad */\n        body::before {\n            content: '';\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: linear-gradient(to right, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0.8) 100%);\n            z-index: -1;\n        }\n\n        .container {\n            width: 100%;\n            max-width: 1400px;\n            margin: 0 auto;\n            padding: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            gap: 40px;\n            min-height: 80vh;\n        }\n\n        /* Panel Izquierdo (Slogan) - Ahora transparente */\n        .left-panel {\n            flex: 1;\n            padding: 40px;\n            /* Sin fondo propio */\n        }\n\n        /* Eliminamos el pseudo-elemento del panel izquierdo anterior */\n        .left-panel::before {\n            display: none;\n        }\n\n        .left-content {\n            position: relative;\n            z-index: 2;\n            color: #fff;\n            text-shadow: 0 2px 10px rgba(0,0,0,0.5);\n        }\n\n        .brand-tag {\n            background: rgba(212, 175, 55, 0.2);\n            border: 1px solid #D4AF37;\n            color: #D4AF37;\n            padding: 5px 15px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            text-transform: uppercase;\n            letter-spacing: 2px;\n            display: inline-block;\n            margin-bottom: 20px;\n            backdrop-filter: blur(5px);\n        }\n\n        .main-slogan {\n            font-size: 4rem; /* M√°s grande */\n            line-height: 1.1;\n            font-weight: 800;\n            margin-bottom: 25px;\n        }\n\n        .main-slogan span {\n            color: #D4AF37;\n            display: block;\n            font-style: italic; /* Estilo m√°s elegante */\n        }\n\n        .sub-slogan {\n            font-size: 1.2rem;\n            color: #eee;\n            line-height: 1.6;\n            max-width: 80%;\n        }\n\n        /* Panel Derecho (Formulario) - Ahora es la tarjeta */\n        .right-panel {\n            flex: 0 0 500px; /* Ancho fijo para el formulario */\n            padding: 40px;\n            background: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente oscuro */\n            backdrop-filter: blur(20px); /* Efecto glassmorphism fuerte */\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 24px;\n            box-shadow: 0 20px 50px rgba(0,0,0,0.5);\n            max-height: 90vh;\n            overflow-y: auto;\n        }\n\n        @media (max-width: 1024px) {\n            .container {\n                flex-direction: column;\n                padding: 40px 20px;\n            }\n            \n            .left-panel {\n                text-align: center;\n                padding: 20px;\n            }\n\n            .sub-slogan {\n                margin: 0 auto;\n            }\n\n            .right-panel {\n                width: 100%;\n                flex: none;\n            }\n\n            .main-slogan {\n                font-size: 2.5rem;\n            }\n        }\n\n        h1 {\n            color: #D4AF37;\n            font-size: 2.5rem;\n            margin-bottom: 10px;\n            text-align: center;\n        }\n\n        .subtitle {\n            text-align: center;\n            color: #aaa;\n            margin-bottom: 40px;\n            font-size: 1.1rem;\n        }\n\n        .form-section {\n            margin-bottom: 30px;\n        }\n\n        .form-section h2 {\n            color: #D4AF37;\n            font-size: 1.3rem;\n            margin-bottom: 20px;\n            padding-bottom: 10px;\n            border-bottom: 2px solid rgba(212, 175, 55, 0.3);\n        }\n\n        .form-group {\n            margin-bottom: 25px;\n            animation: fadeIn 0.3s ease-in;\n            position: relative;\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(-10px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        label {\n            display: block;\n            margin-bottom: 8px;\n            color: #D4AF37;\n            font-weight: 500;\n            font-size: 0.95rem;\n        }\n\n        label .required {\n            color: #ff6b6b;\n            margin-left: 4px;\n        }\n\n        input, select, textarea {\n            width: 100%;\n            padding: 12px 16px;\n            padding-right: 45px; /* Espacio para el icono */\n            background: rgba(255, 255, 255, 0.1);\n            border: 2px solid rgba(212, 175, 55, 0.3);\n            border-radius: 8px;\n            color: #fff;\n            font-size: 1rem;\n            transition: all 0.3s ease;\n        }\n\n        input:focus, select:focus, textarea:focus {\n            outline: none;\n            border-color: #D4AF37;\n            background: rgba(255, 255, 255, 0.15);\n        }\n\n        input::placeholder, textarea::placeholder {\n            color: rgba(255, 255, 255, 0.4);\n        }\n\n        select {\n            cursor: pointer;\n        }\n\n        select option {\n            background: #2d2d2d;\n            color: #fff;\n        }\n\n        textarea {\n            resize: vertical;\n            min-height: 100px;\n        }\n\n        .checkbox-group {\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n        }\n\n        .checkbox-item {\n            display: flex;\n            align-items: center;\n            padding: 10px;\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 8px;\n            transition: all 0.3s ease;\n        }\n\n        .checkbox-item:hover {\n            background: rgba(255, 255, 255, 0.1);\n            transform: translateX(5px);\n        }\n\n        .checkbox-item input[type=\"checkbox\"] {\n            width: 20px;\n            height: 20px;\n            margin-right: 10px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .checkbox-item input[type=\"checkbox\"]:checked {\n            transform: scale(1.2) rotate(360deg);\n        }\n\n        .checkbox-item label {\n            margin: 0;\n            cursor: pointer;\n            flex: 1;\n        }\n\n        .error-message {\n            color: #ff6b6b;\n            font-size: 0.85rem;\n            margin-top: 5px;\n            display: none;\n        }\n\n        .form-group.error input,\n        .form-group.error select,\n        .form-group.error textarea {\n            border-color: #ff6b6b;\n        }\n\n        .form-group.error .error-message {\n            display: block;\n        }\n\n        /* Estilos para validaci√≥n positiva */\n        .form-group.valid input,\n        .form-group.valid select,\n        .form-group.valid textarea {\n            border-color: #51cf66;\n        }\n\n        .success-message {\n            color: #51cf66;\n            font-size: 0.85rem;\n            margin-top: 5px;\n            display: none;\n        }\n\n        .form-group.valid .success-message {\n            display: block;\n        }\n\n        /* Iconos de validaci√≥n */\n        .validation-icon {\n            position: absolute;\n            right: 15px;\n            top: 38px;\n            font-size: 1.2rem;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n            pointer-events: none;\n        }\n\n        .form-group.valid .validation-icon.check {\n            opacity: 1;\n            color: #51cf66;\n        }\n\n        .form-group.error .validation-icon.cross {\n            opacity: 1;\n            color: #ff6b6b;\n        }\n\n        .btn-submit {\n            width: 100%;\n            padding: 16px;\n            background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%);\n            color: #1a1a1a;\n            border: none;\n            border-radius: 8px;\n            font-size: 1.1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            text-transform: uppercase;\n            letter-spacing: 1px;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .btn-submit::before {\n            content: '';\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            width: 0;\n            height: 0;\n            border-radius: 50%;\n            background: rgba(255, 255, 255, 0.3);\n            transform: translate(-50%, -50%);\n            transition: width 0.6s, height 0.6s;\n        }\n\n        .btn-submit:hover::before {\n            width: 300px;\n            height: 300px;\n        }\n\n        .btn-submit:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);\n        }\n\n        .btn-submit:active {\n            transform: translateY(0);\n        }\n\n        .btn-submit:disabled {\n            opacity: 0.6;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .btn-submit.loading {\n            pointer-events: none;\n        }\n\n        .btn-submit.loading::after {\n            content: '';\n            position: absolute;\n            width: 16px;\n            height: 16px;\n            top: 50%;\n            left: 50%;\n            margin-left: -8px;\n            margin-top: -8px;\n            border: 2px solid #1a1a1a;\n            border-radius: 50%;\n            border-top-color: transparent;\n            animation: spin 0.6s linear infinite;\n        }\n\n        @keyframes spin {\n            to { transform: rotate(360deg); }\n        }\n\n        /* Animaci√≥n de √©xito */\n        .success-animation {\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(0, 0, 0, 0.95);\n            backdrop-filter: blur(10px);\n            border: 2px solid #51cf66;\n            border-radius: 20px;\n            padding: 40px;\n            text-align: center;\n            z-index: 10000;\n            opacity: 0;\n            animation: fadeInScale 0.5s ease forwards;\n        }\n\n        @keyframes fadeInScale {\n            from {\n                opacity: 0;\n                transform: translate(-50%, -50%) scale(0.8);\n            }\n            to {\n                opacity: 1;\n                transform: translate(-50%, -50%) scale(1);\n            }\n        }\n\n        .success-animation h3 {\n            color: #51cf66;\n            font-size: 2rem;\n            margin-bottom: 15px;\n        }\n\n        .success-animation p {\n            color: #ddd;\n            font-size: 1.1rem;\n        }\n\n        .success-checkmark {\n            width: 80px;\n            height: 80px;\n            margin: 0 auto 20px;\n            border-radius: 50%;\n            display: block;\n            stroke-width: 3;\n            stroke: #51cf66;\n            stroke-miterlimit: 10;\n            box-shadow: inset 0px 0px 0px #51cf66;\n            animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;\n        }\n\n        .success-checkmark__circle {\n            stroke-dasharray: 166;\n            stroke-dashoffset: 166;\n            stroke-width: 3;\n            stroke-miterlimit: 10;\n            stroke: #51cf66;\n            fill: none;\n            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;\n        }\n\n        .success-checkmark__check {\n            transform-origin: 50% 50%;\n            stroke-dasharray: 48;\n            stroke-dashoffset: 48;\n            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;\n        }\n\n        @keyframes stroke {\n            100% {\n                stroke-dashoffset: 0;\n            }\n        }\n\n        @keyframes scale {\n            0%, 100% {\n                transform: none;\n            }\n            50% {\n                transform: scale3d(1.1, 1.1, 1);\n            }\n        }\n\n        @keyframes fill {\n            100% {\n                box-shadow: inset 0px 0px 0px 30px #51cf66;\n            }\n        }\n\n        #dynamicFields {\n            margin-top: 20px;\n        }\n\n        .info-box {\n            background: rgba(212, 175, 55, 0.1);\n            border-left: 4px solid #D4AF37;\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n        }\n\n        .info-box p {\n            color: #ddd;\n            line-height: 1.6;\n        }\n\n        /* ========================================\n           SISTEMA DE TOOLTIPS INTELIGENTE\n           ======================================== */\n        \n        /* Contenedor del select con tooltip */\n        .package-option {\n            position: relative;\n            display: block;\n            width: 100%;\n        }\n        \n        .package-option select {\n            width: 100%;\n            cursor: pointer;\n        }\n\n        /* Tooltip base - PC */\n        .package-tooltip {\n            position: absolute;\n            left: 50%;\n            width: 350px;\n            background: rgba(0, 0, 0, 0.95);\n            backdrop-filter: blur(10px);\n            border: 2px solid #D4AF37;\n            border-radius: 12px;\n            padding: 20px;\n            opacity: 0;\n            visibility: hidden;\n            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n            z-index: 1000;\n            pointer-events: none;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n        }\n\n        /* Posicionamiento: arriba del select */\n        .package-tooltip.position-top {\n            bottom: 100%;\n            margin-bottom: 15px;\n            transform: translate(-50%, 10px);\n        }\n\n        .package-tooltip.position-top.show {\n            opacity: 1;\n            visibility: visible;\n            transform: translate(-50%, 0);\n        }\n\n        /* Posicionamiento: abajo del select */\n        .package-tooltip.position-bottom {\n            top: 100%;\n            margin-top: 15px;\n            transform: translate(-50%, -10px);\n        }\n\n        .package-tooltip.position-bottom.show {\n            opacity: 1;\n            visibility: visible;\n            transform: translate(-50%, 0);\n        }\n\n        /* Flecha del tooltip - arriba (tooltip debajo del select) */\n        .package-tooltip.position-bottom::before {\n            content: '';\n            position: absolute;\n            left: 50%;\n            top: -10px;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 10px solid transparent;\n            border-right: 10px solid transparent;\n            border-bottom: 10px solid #D4AF37;\n        }\n\n        /* Flecha del tooltip - abajo (tooltip arriba del select) */\n        .package-tooltip.position-top::before {\n            content: '';\n            position: absolute;\n            left: 50%;\n            bottom: -10px;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 10px solid transparent;\n            border-right: 10px solid transparent;\n            border-top: 10px solid #D4AF37;\n        }\n\n        /* Contenido del tooltip */\n        .package-tooltip h4 {\n            color: #D4AF37;\n            font-size: 1.1rem;\n            margin-bottom: 12px;\n            border-bottom: 1px solid rgba(212, 175, 55, 0.3);\n            padding-bottom: 10px;\n            font-weight: 600;\n        }\n\n        .package-tooltip ul {\n            list-style: none;\n            padding: 0;\n            margin: 0;\n        }\n\n        .package-tooltip li {\n            color: #ddd;\n            font-size: 0.9rem;\n            padding: 6px 0;\n            padding-left: 25px;\n            position: relative;\n            line-height: 1.4;\n        }\n\n        .package-tooltip li:before {\n            content: \"‚úì\";\n            position: absolute;\n            left: 0;\n            color: #51cf66;\n            font-weight: bold;\n            font-size: 1rem;\n        }\n\n        /* ========================================\n           DRAWER M√ìVIL (BOTTOM SHEET)\n           ======================================== */\n        @media (max-width: 768px) {\n            .container {\n                padding: 20px;\n            }\n\n            h1 {\n                font-size: 2rem;\n            }\n\n            /* Backdrop oscuro */\n            .tooltip-backdrop {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.7);\n                backdrop-filter: blur(4px);\n                opacity: 0;\n                visibility: hidden;\n                transition: all 0.3s ease;\n                z-index: 999;\n            }\n\n            .tooltip-backdrop.show {\n                opacity: 1;\n                visibility: visible;\n            }\n\n            /* Drawer desde abajo */\n            .package-tooltip {\n                position: fixed;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                top: auto;\n                width: 100%;\n                max-width: 100%;\n                margin: 0;\n                border-radius: 20px 20px 0 0;\n                padding: 24px;\n                transform: translateY(100%);\n                opacity: 1;\n                visibility: visible;\n                pointer-events: auto;\n                max-height: 70vh;\n                overflow-y: auto;\n                z-index: 1000;\n            }\n\n            .package-tooltip.show {\n                transform: translateY(0);\n            }\n\n            /* Eliminar flechas en m√≥vil */\n            .package-tooltip::before {\n                display: none;\n            }\n\n            /* Handle del drawer (l√≠nea superior) */\n            .package-tooltip::after {\n                content: '';\n                position: absolute;\n                top: 12px;\n                left: 50%;\n                transform: translateX(-50%);\n                width: 40px;\n                height: 4px;\n                background: rgba(212, 175, 55, 0.5);\n                border-radius: 2px;\n            }\n\n            /* Ajustar padding superior para el handle */\n            .package-tooltip h4 {\n                margin-top: 8px;\n                font-size: 1.2rem;\n            }\n\n            /* Bot√≥n de cerrar en m√≥vil */\n            .tooltip-close-btn {\n                display: block;\n                position: absolute;\n                top: 16px;\n                right: 16px;\n                background: rgba(212, 175, 55, 0.2);\n                border: 1px solid #D4AF37;\n                color: #D4AF37;\n                width: 32px;\n                height: 32px;\n                border-radius: 50%;\n                font-size: 20px;\n                line-height: 1;\n                cursor: pointer;\n                transition: all 0.2s ease;\n                padding: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .tooltip-close-btn:hover,\n            .tooltip-close-btn:active {\n                background: rgba(212, 175, 55, 0.3);\n                transform: scale(1.1);\n            }\n\n            /* Prevenir scroll del body cuando el drawer est√° abierto */\n            body.tooltip-open {\n                overflow: hidden;\n            }\n        }\n\n        /* Bot√≥n de cerrar oculto en desktop */\n        @media (min-width: 769px) {\n            .tooltip-close-btn {\n                display: none;\n            }\n\n            .tooltip-backdrop {\n                display: none;\n            }\n        }\n\n        /* Estilos del Stepper (Wizard) */\n        .step-indicator {\n            display: flex;\n            justify-content: space-between;\n            margin-bottom: 40px;\n            position: relative;\n            padding: 0 20px;\n        }\n\n        .step-indicator::before {\n            content: '';\n            position: absolute;\n            top: 15px;\n            left: 40px;\n            right: 40px;\n            height: 2px;\n            background: rgba(255, 255, 255, 0.1);\n            z-index: 0;\n        }\n\n        .step {\n            position: relative;\n            z-index: 1;\n            text-align: center;\n            width: 100%;\n        }\n\n        .step-circle {\n            width: 30px;\n            height: 30px;\n            background: #2d2d2d;\n            border: 2px solid rgba(212, 175, 55, 0.3);\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            margin: 0 auto 10px;\n            font-weight: 600;\n            color: #aaa;\n            transition: all 0.3s ease;\n        }\n\n        .step.active .step-circle {\n            border-color: #D4AF37;\n            background: #D4AF37;\n            color: #1a1a1a;\n            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);\n        }\n\n        .step.completed .step-circle {\n            border-color: #51cf66;\n            background: #51cf66;\n            color: #fff;\n        }\n\n        .step-label {\n            font-size: 0.85rem;\n            color: #aaa;\n            display: none;\n            transition: color 0.3s ease;\n        }\n\n        .step.active .step-label,\n        .step.completed .step-label {\n            color: #fff;\n        }\n\n        @media (min-width: 768px) {\n            .step-label { display: block; }\n        }\n\n        /* Pasos del formulario */\n        .form-step {\n            display: none;\n            animation: fadeIn 0.4s ease;\n        }\n\n        .form-step.active {\n            display: block;\n        }\n\n        /* Botones de navegaci√≥n */\n        .form-navigation {\n            display: flex;\n            justify-content: space-between;\n            margin-top: 30px;\n            gap: 15px;\n        }\n\n        .btn-nav {\n            padding: 12px 24px;\n            border-radius: 8px;\n            border: none;\n            font-size: 1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .btn-prev {\n            background: rgba(255, 255, 255, 0.1);\n            color: #fff;\n        }\n\n        .btn-prev:hover {\n            background: rgba(255, 255, 255, 0.2);\n        }\n\n        .btn-next {\n            background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%);\n            color: #1a1a1a;\n            flex: 1;\n        }\n\n        .btn-next:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <!-- Panel Izquierdo -->\n        <div class=\"left-panel\">\n            <div class=\"left-content\">\n                <div class=\"brand-tag\">LIVE MOMENTS PRODUCTION</div>\n                <h1 class=\"main-slogan\" id=\"dynamicSlogan\">\n                    Conserva tus <br>\n                    <span>mejores momentos</span>\n                </h1>\n                <p class=\"sub-slogan\" id=\"dynamicSubSlogan\">\n                    La distancia es solo f√≠sica. Ofrecemos servicios de streaming profesional multic√°mara para que nadie se pierda tu celebraci√≥n.\n                </p>\n            </div>\n        </div>\n\n        <!-- Panel Derecho -->\n        <div class=\"right-panel\">\n            <h2 style=\"text-align: center; margin-bottom: 10px; color: #D4AF37;\">Comienza la Magia</h2>\n            <p class=\"subtitle\">D√©janos tus datos y dise√±aremos una experiencia a medida.</p>\n\n        <!-- Indicador de Pasos -->\n        <div class=\"step-indicator\">\n            <div class=\"step active\">\n                <div class=\"step-circle\">1</div>\n                <div class=\"step-label\">Tipo de Evento</div>\n            </div>\n            <div class=\"step\">\n                <div class=\"step-circle\">2</div>\n                <div class=\"step-label\">Detalles</div>\n            </div>\n            <div class=\"step\">\n                <div class=\"step-circle\">3</div>\n                <div class=\"step-label\">Paquete</div>\n            </div>\n            <div class=\"step\">\n                <div class=\"step-circle\">4</div>\n                <div class=\"step-label\">Contacto</div>\n            </div>\n        </div>\n\n        <form id=\"eventForm\">\n            <!-- PASO 1: TIPO DE EVENTO -->\n            <div class=\"form-step active\">\n                <div class=\"form-section\">\n                    <h2>üìã Tipo de Evento</h2>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"tipo_evento\">Selecciona el tipo de evento <span class=\"required\">*</span></label>\n                        <select id=\"tipo_evento\" name=\"tipo_evento\" required>\n                            <option value=\"\">-- Selecciona una opci√≥n --</option>\n                            <option value=\"Eventos sociales\">üéä Eventos Sociales</option>\n                            <option value=\"Conferencias y eventos corporativos\">üè¢ Conferencias y Eventos Corporativos</option>\n                            <option value=\"E-Sport y Gaming\">üéÆ E-Sports y Gaming</option>\n                            <option value=\"Conciertos y Eventos Art√≠sticos\">üéµ Conciertos y Eventos Art√≠sticos</option>\n                            <option value=\"Eventos Religiosos\">‚õ™ Eventos Religiosos</option>\n                            <option value=\"Eventos Deportivos\">‚öΩ Eventos Deportivos</option>\n                        </select>\n                        <span class=\"error-message\">Por favor selecciona un tipo de evento</span>\n                    </div>\n\n                    <!-- Campos din√°micos se insertar√°n aqu√≠ -->\n                    <div id=\"dynamicFields\"></div>\n                </div>\n            </div>\n\n            <!-- PASO 2: INFORMACI√ìN DEL EVENTO -->\n            <div class=\"form-step\">\n                <div class=\"form-section\">\n                    <h2>üìÖ Informaci√≥n del Evento</h2>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"fecha_evento\">Fecha del evento <span class=\"required\">*</span></label>\n                        <input type=\"date\" id=\"fecha_evento\" name=\"fecha_evento\" required>\n                        <span class=\"error-message\">Selecciona una fecha futura</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"ubicacion_evento\">Ubicaci√≥n del evento <span class=\"required\">*</span></label>\n                        <input type=\"text\" id=\"ubicacion_evento\" name=\"ubicacion_evento\" \n                               placeholder=\"Ciudad, Estado o direcci√≥n espec√≠fica\" required>\n                        <span class=\"error-message\">Ingresa la ubicaci√≥n del evento</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"duracion_estimada\">Duraci√≥n estimada <span class=\"required\">*</span></label>\n                        <select id=\"duracion_estimada\" name=\"duracion_estimada\" required>\n                            <option value=\"\">-- Selecciona --</option>\n                            <option value=\"2 horas\">2 horas</option>\n                            <option value=\"4 horas\">4 horas</option>\n                            <option value=\"6 horas\">6 horas</option>\n                            <option value=\"8 horas\">8 horas</option>\n                            <option value=\"Todo el d√≠a\">Todo el d√≠a</option>\n                            <option value=\"Varios d√≠as\">Varios d√≠as</option>\n                        </select>\n                        <span class=\"error-message\">Selecciona la duraci√≥n estimada</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"tiene_internet_venue\">¬øEl lugar cuenta con internet? <span class=\"required\">*</span></label>\n                        <select id=\"tiene_internet_venue\" name=\"tiene_internet_venue\" required>\n                            <option value=\"\">-- Selecciona --</option>\n                            <option value=\"S√≠\">S√≠</option>\n                            <option value=\"No\">No</option>\n                            <option value=\"No estoy seguro\">No estoy seguro</option>\n                        </select>\n                        <span class=\"error-message\">Selecciona una opci√≥n</span>\n                    </div>\n                </div>\n            </div>\n\n            <!-- PASO 3: PAQUETE Y ADD-ONS -->\n            <div class=\"form-step\">\n                <div class=\"form-section\">\n                    <h2>üì¶ Paquete y Servicios</h2>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"paquete_interes\">Paquete de inter√©s <span class=\"required\">*</span></label>\n                        \n                        <div class=\"package-option\">\n                            <select id=\"paquete_interes\" name=\"paquete_interes\" required>\n                                <option value=\"\">-- Selecciona --</option>\n                                <option value=\"B√°sico\" data-package=\"basico\">ü•â B√°sico - 1 c√°mara HD</option>\n                                <option value=\"Est√°ndar\" data-package=\"estandar\">ü•à Est√°ndar - 2 c√°maras HD + overlays b√°sicos</option>\n                                <option value=\"Premium\" data-package=\"premium\">ü•á Premium - 3 c√°maras HD + director t√©cnico</option>\n                                <option value=\"Enterprise\" data-package=\"enterprise\">üíé Enterprise - 4 c√°maras 4K + multi-plataforma</option>\n                                <option value=\"No estoy seguro\">‚ùì No estoy seguro</option>\n                            </select>\n                            \n                            <!-- Tooltip que aparecer√° al hacer hover -->\n                            <div id=\"packageTooltip\" class=\"package-tooltip\" style=\"display: none;\">\n                                <button id=\"tooltipCloseBtn\" class=\"tooltip-close-btn\" aria-label=\"Cerrar\">√ó</button>\n                                <h4 id=\"tooltipTitle\"></h4>\n                                <ul id=\"tooltipContent\"></ul>\n                            </div>\n                        </div>\n                        \n                        <span class=\"error-message\">Selecciona un paquete</span>\n                    </div>\n                    \n                    <!-- Backdrop para m√≥vil -->\n                    <div id=\"tooltipBackdrop\" class=\"tooltip-backdrop\"></div>\n\n                    <!-- Info box con detalles de paquetes -->\n                    <div class=\"info-box\" style=\"margin-top: 15px;\">\n                        <p><strong>üí° Pasa el mouse sobre cada paquete para ver los detalles completos</strong></p>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label>Servicios adicionales (opcional)</label>\n                        <div class=\"checkbox-group\">\n                            <div class=\"checkbox-item\">\n                                <input type=\"checkbox\" id=\"addon_camara\" name=\"add_ons\" value=\"C√°mara + Micr√≥fono Adicional\">\n                                <label for=\"addon_camara\">üìπ C√°maras + Micr√≥fonos adicionales</label>\n                            </div>\n                            <div class=\"checkbox-item\">\n                                <input type=\"checkbox\" id=\"addon_starlink\" name=\"add_ons\" value=\"Internet Starlink\">\n                                <label for=\"addon_starlink\">üõ∞Ô∏è Internet Starlink (Garant√≠a de conectividad)</label>\n                            </div>\n                            <div class=\"checkbox-item\">\n                                <input type=\"checkbox\" id=\"addon_overlays\" name=\"add_ons\" value=\"Overlays Personalizados\">\n                                <label for=\"addon_overlays\">üé® Overlays Personalizados</label>\n                            </div>\n                            <div class=\"checkbox-item\">\n                                <input type=\"checkbox\" id=\"addon_plataforma\" name=\"add_ons\" value=\"Plataforma Adicional\">\n                                <label for=\"addon_plataforma\">üì∫ Plataforma Adicional (Solo Enterprise)</label>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- PASO 4: DATOS DE CONTACTO -->\n            <div class=\"form-step\">\n                <div class=\"form-section\">\n                    <h2>üë§ Datos de Contacto</h2>\n                    \n                    <div class=\"form-group\">\n                        <label for=\"nombre_cliente\">Nombre completo <span class=\"required\">*</span></label>\n                        <input type=\"text\" id=\"nombre_cliente\" name=\"nombre_cliente\" \n                               placeholder=\"Juan P√©rez\" required>\n                        <span class=\"validation-icon check\">‚úì</span>\n                        <span class=\"validation-icon cross\">‚úó</span>\n                        <span class=\"error-message\">Ingresa tu nombre completo (m√≠nimo 3 caracteres)</span>\n                        <span class=\"success-message\">‚úì Nombre v√°lido</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"email_cliente\">Correo electr√≥nico <span class=\"required\">*</span></label>\n                        <input type=\"email\" id=\"email_cliente\" name=\"email_cliente\" \n                               placeholder=\"juan@email.com\" required>\n                        <span class=\"validation-icon check\">‚úì</span>\n                        <span class=\"validation-icon cross\">‚úó</span>\n                        <span class=\"error-message\">Ingresa un email v√°lido</span>\n                        <span class=\"success-message\">‚úì Email v√°lido</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"telefono_cliente\">Tel√©fono / WhatsApp <span class=\"required\">*</span></label>\n                        <input type=\"tel\" id=\"telefono_cliente\" name=\"telefono_cliente\" \n                               placeholder=\"+58 412 1234567\" required>\n                        <span class=\"validation-icon check\">‚úì</span>\n                        <span class=\"validation-icon cross\">‚úó</span>\n                        <span class=\"error-message\">Ingresa un tel√©fono v√°lido (m√≠nimo 10 d√≠gitos)</span>\n                        <span class=\"success-message\">‚úì Tel√©fono v√°lido</span>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"comentarios_adicionales\">Comentarios adicionales (opcional)</label>\n                        <textarea id=\"comentarios_adicionales\" name=\"comentarios_adicionales\" \n                                  placeholder=\"Cu√©ntanos m√°s sobre tu evento, necesidades especiales, presupuesto aproximado, etc.\"></textarea>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Botones de Navegaci√≥n -->\n            <div class=\"form-navigation\">\n                <button type=\"button\" id=\"prevBtn\" class=\"btn-nav btn-prev\" onclick=\"nextPrev(-1)\" style=\"display: none;\">Anterior</button>\n                <button type=\"button\" id=\"nextBtn\" class=\"btn-nav btn-next\" onclick=\"nextPrev(1)\">Siguiente</button>\n                <button type=\"submit\" id=\"submitBtn\" class=\"btn-submit\" style=\"display: none;\">Enviar Solicitud</button>\n            </div>\n        </form>\n        </div> <!-- Fin right-panel -->\n    </div> <!-- Fin container -->\n\n    <script>\n        // ========================================\n        // CONFIGURACI√ìN DE CAMPOS DIN√ÅMICOS\n        // ========================================\n        \n        const camposDinamicos = {\n            \"Eventos sociales\": [\n                {\n                    type: \"select\",\n                    name: \"tipo_celebracion\",\n                    label: \"Tipo de celebraci√≥n\",\n                    required: true,\n                    options: [\"Boda\", \"Quincea√±era\", \"Aniversario\", \"Baby Shower\", \"Otro\"]\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_invitados\",\n                    label: \"N√∫mero aproximado de invitados\",\n                    required: false,\n                    placeholder: \"150\"\n                },\n                {\n                    type: \"checkboxes\",\n                    name: \"momentos_clave\",\n                    label: \"Momentos clave a transmitir\",\n                    required: false,\n                    options: [\"Toda la Ceremonia\", \"Entrada del evento\", \"Momentos especiales\", \"Brindis\"]\n                }\n            ],\n            \"Conferencias y eventos corporativos\": [\n                {\n                    type: \"text\",\n                    name: \"nombre_empresa\",\n                    label: \"Nombre de la empresa\",\n                    required: true,\n                    placeholder: \"Empresa XYZ C.A.\"\n                },\n                {\n                    type: \"select\",\n                    name: \"tipo_conferencia\",\n                    label: \"Tipo de conferencia\",\n                    required: true,\n                    options: [\"Seminario\", \"Capacitaci√≥n\", \"Lanzamiento de producto\", \"Asamblea\", \"Evento corporativo\"]\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_speakers\",\n                    label: \"N√∫mero de speakers/ponentes\",\n                    required: false,\n                    placeholder: \"3\"\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_asistentes\",\n                    label: \"N√∫mero aproximado de asistentes\",\n                    required: false,\n                    placeholder: \"200\"\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_grabacion\",\n                    label: \"¬øNecesita grabaci√≥n del evento?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                },\n                {\n                    type: \"checkboxes\",\n                    name: \"plataformas_destino\",\n                    label: \"Plataformas de destino\",\n                    required: false,\n                    options: [\"YouTube\", \"Facebook\", \"LinkedIn\", \"Plataforma privada\"]\n                }\n            ],\n            \"E-Sport y Gaming\": [\n                {\n                    type: \"text\",\n                    name: \"juego_plataforma\",\n                    label: \"Juego o plataforma\",\n                    required: true,\n                    placeholder: \"League of Legends, Fortnite, etc.\"\n                },\n                {\n                    type: \"select\",\n                    name: \"tipo_torneo\",\n                    label: \"Tipo de torneo\",\n                    required: true,\n                    options: [\"Local\", \"Nacional\", \"Internacional\", \"Amistoso\"]\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_equipos\",\n                    label: \"N√∫mero de equipos\",\n                    required: false,\n                    placeholder: \"8\"\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_jugadores\",\n                    label: \"N√∫mero total de jugadores\",\n                    required: false,\n                    placeholder: \"40\"\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_scoreboards\",\n                    label: \"¬øNecesita scoreboards?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_comentaristas\",\n                    label: \"¬øHabr√° comentaristas?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                },\n                {\n                    type: \"checkboxes\",\n                    name: \"plataformas_destino\",\n                    label: \"Plataformas de streaming\",\n                    required: false,\n                    options: [\"Twitch\", \"YouTube\", \"Facebook Gaming\", \"Kick\"]\n                }\n            ],\n            \"Conciertos y Eventos Art√≠sticos\": [\n                {\n                    type: \"select\",\n                    name: \"tipo_evento_artistico\",\n                    label: \"Tipo de evento\",\n                    required: true,\n                    options: [\"Concierto\", \"Teatro\", \"Stand-up comedy\", \"Performance\", \"Festival\"]\n                },\n                {\n                    type: \"text\",\n                    name: \"nombre_artista\",\n                    label: \"Nombre del artista/banda\",\n                    required: false,\n                    placeholder: \"Banda XYZ\"\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_artistas\",\n                    label: \"N√∫mero de artistas\",\n                    required: false,\n                    placeholder: \"5\"\n                },\n                {\n                    type: \"select\",\n                    name: \"tipo_venue\",\n                    label: \"Tipo de venue\",\n                    required: false,\n                    options: [\"Cerrado\", \"Abierto\", \"Teatro\", \"Club\"]\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_audio_profesional\",\n                    label: \"¬øNecesita audio profesional?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                }\n            ],\n            \"Eventos Religiosos\": [\n                {\n                    type: \"select\",\n                    name: \"tipo_ceremonia\",\n                    label: \"Tipo de ceremonia\",\n                    required: true,\n                    options: [\"Misa\", \"Culto\", \"Bautizo\", \"Primera Comuni√≥n\", \"Boda religiosa\", \"Otro\"]\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_asistentes\",\n                    label: \"N√∫mero aproximado de asistentes\",\n                    required: false,\n                    placeholder: \"100\"\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_audio_claro\",\n                    label: \"¬øNecesita audio especial para sermones/pr√©dicas?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                }\n            ],\n            \"Eventos Deportivos\": [\n                {\n                    type: \"text\",\n                    name: \"tipo_deporte\",\n                    label: \"Tipo de deporte\",\n                    required: true,\n                    placeholder: \"F√∫tbol, Baloncesto, etc.\"\n                },\n                {\n                    type: \"select\",\n                    name: \"tipo_evento_deportivo\",\n                    label: \"Tipo de evento\",\n                    required: true,\n                    options: [\"Partido √∫nico\", \"Torneo\", \"Liga\", \"Amistoso\"]\n                },\n                {\n                    type: \"number\",\n                    name: \"numero_equipos\",\n                    label: \"N√∫mero de equipos\",\n                    required: false,\n                    placeholder: \"2\"\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_scoreboards\",\n                    label: \"¬øNecesita scoreboards?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                },\n                {\n                    type: \"select\",\n                    name: \"necesita_replays\",\n                    label: \"¬øNecesita replays?\",\n                    required: false,\n                    options: [\"S√≠\", \"No\"]\n                },\n                {\n                    type: \"select\",\n                    name: \"tipo_venue_deportivo\",\n                    label: \"Tipo de venue\",\n                    required: false,\n                    options: [\"Estadio\", \"Cancha abierta\", \"Gimnasio\", \"Otro\"]\n                }\n            ]\n        };\n\n        // ========================================\n        // FUNCIONES PRINCIPALES\n        // ========================================\n\n        // Funci√≥n para renderizar campos din√°micos\n        function renderizarCamposDinamicos(tipoEvento) {\n            const container = document.getElementById('dynamicFields');\n            container.innerHTML = ''; // Limpiar campos anteriores\n\n            if (!tipoEvento || !camposDinamicos[tipoEvento]) {\n                return;\n            }\n\n            const campos = camposDinamicos[tipoEvento];\n            \n            campos.forEach(campo => {\n                const formGroup = document.createElement('div');\n                formGroup.className = 'form-group';\n\n                const label = document.createElement('label');\n                label.textContent = campo.label;\n                if (campo.required) {\n                    const required = document.createElement('span');\n                    required.className = 'required';\n                    required.textContent = ' *';\n                    label.appendChild(required);\n                }\n                formGroup.appendChild(label);\n\n                // Crear el input seg√∫n el tipo\n                if (campo.type === 'text' || campo.type === 'number') {\n                    const input = document.createElement('input');\n                    input.type = campo.type;\n                    input.name = campo.name;\n                    input.id = campo.name;\n                    if (campo.placeholder) input.placeholder = campo.placeholder;\n                    if (campo.required) input.required = true;\n                    formGroup.appendChild(input);\n                } else if (campo.type === 'select') {\n                    const select = document.createElement('select');\n                    select.name = campo.name;\n                    select.id = campo.name;\n                    if (campo.required) select.required = true;\n\n                    const defaultOption = document.createElement('option');\n                    defaultOption.value = '';\n                    defaultOption.textContent = '-- Selecciona --';\n                    select.appendChild(defaultOption);\n\n                    campo.options.forEach(opcion => {\n                        const option = document.createElement('option');\n                        option.value = opcion;\n                        option.textContent = opcion;\n                        select.appendChild(option);\n                    });\n\n                    formGroup.appendChild(select);\n                } else if (campo.type === 'checkboxes') {\n                    const checkboxGroup = document.createElement('div');\n                    checkboxGroup.className = 'checkbox-group';\n\n                    campo.options.forEach((opcion, index) => {\n                        const checkboxItem = document.createElement('div');\n                        checkboxItem.className = 'checkbox-item';\n\n                        const checkbox = document.createElement('input');\n                        checkbox.type = 'checkbox';\n                        checkbox.name = campo.name;\n                        checkbox.id = `${campo.name}_${index}`;\n                        checkbox.value = opcion;\n\n                        const checkboxLabel = document.createElement('label');\n                        checkboxLabel.htmlFor = `${campo.name}_${index}`;\n                        checkboxLabel.textContent = opcion;\n\n                        checkboxItem.appendChild(checkbox);\n                        checkboxItem.appendChild(checkboxLabel);\n                        checkboxGroup.appendChild(checkboxItem);\n                    });\n\n                    formGroup.appendChild(checkboxGroup);\n                }\n\n                const errorMessage = document.createElement('span');\n                errorMessage.className = 'error-message';\n                errorMessage.textContent = 'Este campo es obligatorio';\n                formGroup.appendChild(errorMessage);\n\n                container.appendChild(formGroup);\n            });\n        }\n\n        // ========================================\n        // VALIDACI√ìN EN TIEMPO REAL\n        // ========================================\n\n        // Funci√≥n para validar un campo\n        function validarCampo(input) {\n            const formGroup = input.closest('.form-group');\n            const valor = input.value.trim();\n            let esValido = false;\n\n            // Validar seg√∫n el tipo de campo\n            if (input.id === 'nombre_cliente') {\n                esValido = valor.length >= 3;\n            } else if (input.id === 'email_cliente') {\n                const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n                esValido = emailRegex.test(valor);\n            } else if (input.id === 'telefono_cliente') {\n                const telefonoLimpio = valor.replace(/\\D/g, '');\n                esValido = telefonoLimpio.length >= 10;\n            } else if (input.required) {\n                esValido = valor.length > 0;\n            }\n\n            // Aplicar clases seg√∫n validaci√≥n\n            if (esValido) {\n                formGroup.classList.remove('error');\n                formGroup.classList.add('valid');\n            } else if (valor.length > 0) {\n                formGroup.classList.remove('valid');\n                formGroup.classList.add('error');\n            } else {\n                formGroup.classList.remove('valid', 'error');\n            }\n        }\n\n        // Event listeners para validaci√≥n en tiempo real\n        // Nombre\n        document.getElementById('nombre_cliente').addEventListener('input', function() {\n            validarCampo(this);\n        });\n\n        // Email\n        document.getElementById('email_cliente').addEventListener('input', function() {\n            validarCampo(this);\n        });\n\n        // Tel√©fono\n        document.getElementById('telefono_cliente').addEventListener('input', function() {\n            validarCampo(this);\n        });\n\n        // ========================================\n        // SISTEMA DE TOOLTIPS INTELIGENTE\n        // ========================================\n\n        // Informaci√≥n detallada de cada paquete\n        const paquetesInfo = {\n            basico: {\n                titulo: \"ü•â Paquete B√°sico\",\n                items: [\n                    \"1 c√°mara HD\",\n                    \"1 micr√≥fono inal√°mbrico\",\n                    \"Streaming a 1 plataforma\",\n                    \"Sin overlays\",\n                    \"Operador t√©cnico b√°sico\"\n                ]\n            },\n            estandar: {\n                titulo: \"ü•à Paquete Est√°ndar\",\n                items: [\n                    \"2 c√°maras HD\",\n                    \"2 micr√≥fonos inal√°mbricos\",\n                    \"Streaming a 1 plataforma\",\n                    \"Overlays b√°sicos (templates predefinidos)\",\n                    \"Operador t√©cnico b√°sico\"\n                ]\n            },\n            premium: {\n                titulo: \"ü•á Paquete Premium\",\n                items: [\n                    \"3 c√°maras HD\",\n                    \"3 micr√≥fonos profesionales + mezclador\",\n                    \"Streaming a 1 plataforma\",\n                    \"Overlays avanzados (animaciones, lower thirds)\",\n                    \"Director t√©cnico profesional\"\n                ]\n            },\n            enterprise: {\n                titulo: \"üíé Paquete Enterprise\",\n                items: [\n                    \"4 c√°maras 4K\",\n                    \"4 micr√≥fonos profesionales + mezclador\",\n                    \"Streaming simult√°neo a hasta 3 plataformas\",\n                    \"Overlays avanzados + branding personalizado\",\n                    \"Director t√©cnico + asistente\"\n                ]\n            }\n        };\n\n        // Referencias a elementos del DOM\n        const selectPaquete = document.getElementById('paquete_interes');\n        const tooltip = document.getElementById('packageTooltip');\n        const tooltipTitle = document.getElementById('tooltipTitle');\n        const tooltipContent = document.getElementById('tooltipContent');\n        const tooltipBackdrop = document.getElementById('tooltipBackdrop');\n        const tooltipCloseBtn = document.getElementById('tooltipCloseBtn');\n\n        let tooltipTimeout;\n        const isMobile = () => window.innerWidth <= 768;\n\n        // Funci√≥n para detectar espacio disponible y posicionar tooltip\n        function posicionarTooltipInteligente() {\n            if (isMobile()) {\n                // En m√≥vil, siempre usar drawer (sin clases de posici√≥n)\n                tooltip.classList.remove('position-top', 'position-bottom');\n                return;\n            }\n\n            const selectRect = selectPaquete.getBoundingClientRect();\n            const tooltipHeight = 280; // Altura aproximada del tooltip\n            const margin = 15;\n\n            // Calcular espacio disponible arriba y abajo\n            const espacioArribaDisponible = selectRect.top - margin;\n            const espacioAbajoDisponible = window.innerHeight - selectRect.bottom - margin;\n\n            // Decidir posici√≥n: preferir arriba, pero si no hay espacio, abajo\n            if (espacioArribaDisponible >= tooltipHeight) {\n                // Hay espacio arriba - posici√≥n preferida\n                tooltip.classList.remove('position-bottom');\n                tooltip.classList.add('position-top');\n            } else if (espacioAbajoDisponible >= tooltipHeight) {\n                // No hay espacio arriba, pero s√≠ abajo\n                tooltip.classList.remove('position-top');\n                tooltip.classList.add('position-bottom');\n            } else {\n                // No hay suficiente espacio en ning√∫n lado, usar el que tenga m√°s\n                if (espacioArribaDisponible > espacioAbajoDisponible) {\n                    tooltip.classList.remove('position-bottom');\n                    tooltip.classList.add('position-top');\n                } else {\n                    tooltip.classList.remove('position-top');\n                    tooltip.classList.add('position-bottom');\n                }\n            }\n        }\n\n        // Funci√≥n para actualizar contenido del tooltip\n        function actualizarContenidoTooltip(packageType) {\n            if (!packageType || !paquetesInfo[packageType]) {\n                return false;\n            }\n\n            const info = paquetesInfo[packageType];\n            \n            // Actualizar contenido\n            tooltipTitle.textContent = info.titulo;\n            tooltipContent.innerHTML = '';\n            \n            info.items.forEach(item => {\n                const li = document.createElement('li');\n                li.textContent = item;\n                tooltipContent.appendChild(li);\n            });\n\n            return true;\n        }\n\n        // Funci√≥n para mostrar tooltip\n        function mostrarTooltip() {\n            const selectedOption = selectPaquete.options[selectPaquete.selectedIndex];\n            const packageType = selectedOption.getAttribute('data-package');\n            \n            if (!actualizarContenidoTooltip(packageType)) {\n                return;\n            }\n\n            if (isMobile()) {\n                // M√≥vil: Mostrar drawer\n                tooltipBackdrop.classList.add('show');\n                tooltip.style.display = 'block';\n                document.body.classList.add('tooltip-open');\n                \n                // Peque√±o delay para la animaci√≥n\n                setTimeout(() => {\n                    tooltip.classList.add('show');\n                }, 10);\n            } else {\n                // PC: Mostrar tooltip con posicionamiento inteligente\n                posicionarTooltipInteligente();\n                tooltip.style.display = 'block';\n                \n                setTimeout(() => {\n                    tooltip.classList.add('show');\n                }, 10);\n            }\n        }\n\n        // Funci√≥n para ocultar tooltip\n        function ocultarTooltip() {\n            tooltip.classList.remove('show');\n            tooltipBackdrop.classList.remove('show');\n            document.body.classList.remove('tooltip-open');\n            \n            setTimeout(() => {\n                tooltip.style.display = 'none';\n            }, 300); // Esperar a que termine la animaci√≥n\n        }\n\n        // Event Listeners\n\n        // Hover sobre el select (PC)\n        selectPaquete.addEventListener('mouseenter', function() {\n            if (!isMobile()) {\n                clearTimeout(tooltipTimeout);\n                tooltipTimeout = setTimeout(mostrarTooltip, 200);\n            }\n        });\n\n        selectPaquete.addEventListener('mouseleave', function() {\n            if (!isMobile()) {\n                clearTimeout(tooltipTimeout);\n                ocultarTooltip();\n            }\n        });\n\n        // Focus en el select (M√≥vil)\n        selectPaquete.addEventListener('focus', function() {\n            if (isMobile()) {\n                const selectedOption = this.options[this.selectedIndex];\n                const packageType = selectedOption.getAttribute('data-package');\n                if (packageType) {\n                    setTimeout(mostrarTooltip, 300);\n                }\n            }\n        });\n\n        // Actualizar tooltip al cambiar de opci√≥n\n        selectPaquete.addEventListener('change', function() {\n            const selectedOption = this.options[this.selectedIndex];\n            const packageType = selectedOption.getAttribute('data-package');\n            \n            if (packageType && paquetesInfo[packageType]) {\n                actualizarContenidoTooltip(packageType);\n                \n                // En m√≥vil, mostrar el drawer autom√°ticamente al seleccionar\n                if (isMobile()) {\n                    mostrarTooltip();\n                }\n            }\n        });\n\n        // Cerrar tooltip con el bot√≥n X (m√≥vil)\n        tooltipCloseBtn.addEventListener('click', function(e) {\n            e.preventDefault();\n            e.stopPropagation();\n            ocultarTooltip();\n        });\n\n        // Cerrar tooltip al hacer click en el backdrop (m√≥vil)\n        tooltipBackdrop.addEventListener('click', function() {\n            ocultarTooltip();\n        });\n\n        // Prevenir que el click dentro del tooltip lo cierre\n        tooltip.addEventListener('click', function(e) {\n            e.stopPropagation();\n        });\n\n        // Reposicionar tooltip al hacer resize\n        let resizeTimeout;\n        window.addEventListener('resize', function() {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(() => {\n                // Si el tooltip est√° visible y estamos en PC, reposicionar\n                if (!isMobile() && tooltip.classList.contains('show')) {\n                    posicionarTooltipInteligente();\n                }\n                // Si cambiamos de PC a m√≥vil o viceversa mientras est√° abierto, cerrar\n                const wasMobile = tooltip.style.position === 'fixed';\n                const isNowMobile = isMobile();\n                if (wasMobile !== isNowMobile && tooltip.classList.contains('show')) {\n                    ocultarTooltip();\n                }\n            }, 100);\n        });\n\n        // Cerrar con tecla ESC\n        document.addEventListener('keydown', function(e) {\n            if (e.key === 'Escape' && tooltip.classList.contains('show')) {\n                ocultarTooltip();\n            }\n        });\n\n        // Event listener para cambio de tipo de evento\n        document.getElementById('tipo_evento').addEventListener('change', function() {\n            renderizarCamposDinamicos(this.value);\n        });\n\n        // Validaci√≥n de fecha (debe ser futura)\n        document.getElementById('fecha_evento').addEventListener('change', function() {\n            const fechaSeleccionada = new Date(this.value);\n            const hoy = new Date();\n            hoy.setHours(0, 0, 0, 0);\n\n            if (fechaSeleccionada <= hoy) {\n                this.parentElement.classList.add('error');\n            } else {\n                this.parentElement.classList.remove('error');\n            }\n        });\n\n        // Manejo del env√≠o del formulario\n        document.getElementById('eventForm').addEventListener('submit', async function(e) {\n            e.preventDefault();\n\n            // Validar formulario\n            if (!validarFormulario()) {\n                alert('Por favor completa todos los campos obligatorios correctamente');\n                return;\n            }\n\n            const btn = document.getElementById('submitBtn');\n            const originalText = btn.innerHTML;\n            \n            // 1. Estado de carga\n            btn.classList.add('loading', 'disabled');\n            btn.innerHTML = ''; // El spinner se muestra v√≠a CSS ::after\n\n            try {\n                // 2. Recopilar datos\n                const formData = {\n                    tipo_evento: document.getElementById('tipo_evento').value,\n                    fecha_evento: document.getElementById('fecha_evento').value,\n                    ubicacion_evento: document.getElementById('ubicacion_evento').value,\n                    duracion_estimada: document.getElementById('duracion_estimada').value,\n                    tiene_internet_venue: document.querySelector('input[name=\"internet\"]:checked')?.value || \"No especificado\",\n                    paquete_interes: document.getElementById('paquete_interes').value,\n                    nombre_cliente: document.getElementById('nombre_cliente').value,\n                    email_cliente: document.getElementById('email_cliente').value,\n                    telefono_cliente: document.getElementById('telefono_cliente').value,\n                    comentarios_adicionales: document.getElementById('comentarios_adicionales').value,\n                    timestamp: new Date().toISOString()\n                };\n\n                // Recopilar Add-ons (checkboxes)\n                const addOns = [];\n                document.querySelectorAll('input[name=\"add_ons\"]:checked').forEach(cb => {\n                    addOns.push(cb.value);\n                });\n                formData.add_ons_solicitados = addOns;\n\n                // Recopilar campos din√°micos espec√≠ficos\n                const dynamicInputs = document.querySelectorAll('#dynamicFields input, #dynamicFields select');\n                dynamicInputs.forEach(input => {\n                    if (input.type === 'checkbox') {\n                        if (!formData[input.name]) {\n                            formData[input.name] = [];\n                        }\n                        if (input.checked) {\n                            formData[input.name].push(input.value);\n                        }\n                    } else if (input.type !== 'radio') {\n                        formData[input.id] = input.value;\n                    }\n                });\n\n                console.log(\"Enviando datos a N8N:\", formData);\n\n                // 3. Enviar a N8N Webhook\n                const webhookUrl = window.WEBHOOK_URL || '...fallback...';\n                \n                const response = await fetch(webhookUrl, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(formData)\n                });\n\n                if (response.ok) {\n                    // 4. √âxito\n                    btn.classList.remove('loading', 'disabled');\n                    btn.innerHTML = originalText;\n                    mostrarAnimacionExito();\n                    \n                    // Resetear formulario\n                    setTimeout(() => {\n                        document.getElementById(\"eventForm\").reset();\n                        showStep(0);\n                        \n                        const tipoEvento = document.getElementById('tipo_evento').value;\n                        if(typeof renderizarCamposDinamicos === 'function') {\n                            renderizarCamposDinamicos(tipoEvento);\n                        }\n                        if(typeof updateBackground === 'function') {\n                            updateBackground(tipoEvento);\n                        }\n                    }, 3000);\n                } else {\n                    throw new Error('Error en la respuesta del servidor');\n                }\n\n            } catch (error) {\n                console.error('Error:', error);\n                btn.classList.remove('loading', 'disabled');\n                btn.innerHTML = originalText;\n                alert('Hubo un error al enviar la solicitud. Por favor, int√©ntalo de nuevo.');\n            }\n        });\n        \n        function validarFormulario() {\n            let valido = true;\n            const form = document.getElementById('eventForm');\n            const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');\n\n            inputs.forEach(input => {\n                const formGroup = input.closest('.form-group');\n                \n                if (!input.value.trim()) {\n                    formGroup.classList.add('error');\n                    valido = false;\n                } else {\n                    formGroup.classList.remove('error');\n                }\n            });\n\n            // Validar email\n            const email = document.getElementById('email_cliente');\n            const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n            if (!emailRegex.test(email.value)) {\n                email.closest('.form-group').classList.add('error');\n                valido = false;\n            }\n\n            // Validar tel√©fono (m√≠nimo 10 d√≠gitos)\n            const telefono = document.getElementById('telefono_cliente');\n            const telefonoLimpio = telefono.value.replace(/\\D/g, '');\n            if (telefonoLimpio.length < 10) {\n                telefono.closest('.form-group').classList.add('error');\n                valido = false;\n            }\n\n            return valido;\n        }\n\n        function recopilarDatos() {\n            const formData = {\n                // Campos universales\n                tipo_evento: document.getElementById('tipo_evento').value,\n                fecha_evento: document.getElementById('fecha_evento').value,\n                ubicacion_evento: document.getElementById('ubicacion_evento').value,\n                duracion_estimada: document.getElementById('duracion_estimada').value,\n                tiene_internet_venue: document.getElementById('tiene_internet_venue').value,\n                paquete_interes: document.getElementById('paquete_interes').value,\n                nombre_cliente: document.getElementById('nombre_cliente').value,\n                email_cliente: document.getElementById('email_cliente').value,\n                telefono_cliente: document.getElementById('telefono_cliente').value,\n                comentarios_adicionales: document.getElementById('comentarios_adicionales').value,\n                \n                // Add-ons\n                add_ons_solicitados: []\n            };\n\n            // Recopilar add-ons seleccionados\n            document.querySelectorAll('input[name=\"add_ons\"]:checked').forEach(checkbox => {\n                formData.add_ons_solicitados.push(checkbox.value);\n            });\n\n            // Recopilar campos din√°micos\n            const dynamicFields = document.getElementById('dynamicFields');\n            const inputs = dynamicFields.querySelectorAll('input, select');\n            \n            inputs.forEach(input => {\n                if (input.type === 'checkbox') {\n                    if (!formData[input.name]) {\n                        formData[input.name] = [];\n                    }\n                    if (input.checked) {\n                        formData[input.name].push(input.value);\n                    }\n                } else {\n                    formData[input.name] = input.value;\n                }\n            });\n\n            return formData;\n        }\n\n        // ========================================\n        // ANIMACI√ìN DE √âXITO\n        // ========================================\n\n        // ========================================\n        // WIZARD / STEPPER LOGIC\n        // ========================================\n\n        let currentStep = 0;\n        showStep(currentStep);\n\n        function showStep(n) {\n            // Mostrar el paso actual\n            const steps = document.getElementsByClassName(\"form-step\");\n            steps[n].classList.add(\"active\");\n            \n            // Ocultar otros pasos\n            for (let i = 0; i < steps.length; i++) {\n                if (i !== n) {\n                    steps[i].classList.remove(\"active\");\n                }\n            }\n\n            // Actualizar botones\n            if (n == 0) {\n                document.getElementById(\"prevBtn\").style.display = \"none\";\n            } else {\n                document.getElementById(\"prevBtn\").style.display = \"inline\";\n            }\n\n            if (n == (steps.length - 1)) {\n                document.getElementById(\"nextBtn\").style.display = \"none\";\n                document.getElementById(\"submitBtn\").style.display = \"inline\";\n            } else {\n                document.getElementById(\"nextBtn\").style.display = \"inline\";\n                document.getElementById(\"nextBtn\").innerHTML = \"Siguiente\";\n                document.getElementById(\"submitBtn\").style.display = \"none\";\n            }\n\n            // Actualizar indicador de pasos\n            updateStepIndicator(n);\n        }\n\n        function nextPrev(n) {\n            const steps = document.getElementsByClassName(\"form-step\");\n            \n            // Si vamos adelante, validar el paso actual\n            if (n == 1 && !validateStep(currentStep)) return false;\n\n            // Ocultar paso actual\n            steps[currentStep].classList.remove(\"active\");\n            \n            // Incrementar/Decrementar paso\n            currentStep = currentStep + n;\n\n            // Si llegamos al final (aunque el submit maneja esto, es bueno tenerlo)\n            if (currentStep >= steps.length) {\n                return false;\n            }\n\n            showStep(currentStep);\n        }\n\n        function validateStep(n) {\n            const steps = document.getElementsByClassName(\"form-step\");\n            const inputs = steps[n].querySelectorAll(\"input, select, textarea\");\n            let valid = true;\n\n            for (let i = 0; i < inputs.length; i++) {\n                // Si el campo es requerido y est√° vac√≠o\n                if (inputs[i].hasAttribute(\"required\") && inputs[i].value.trim() === \"\") {\n                    inputs[i].className += \" invalid\"; // Agregar clase para estilo si se desea\n                    const formGroup = inputs[i].closest('.form-group');\n                    formGroup.classList.add('error');\n                    valid = false;\n                }\n                \n                // Validaciones espec√≠ficas\n                if (inputs[i].id === 'nombre_cliente' && inputs[i].value.trim().length < 3) {\n                    valid = false;\n                    const formGroup = inputs[i].closest('.form-group');\n                    formGroup.classList.add('error');\n                }\n                \n                if (inputs[i].id === 'email_cliente') {\n                    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n                    if (!emailRegex.test(inputs[i].value.trim())) {\n                        valid = false;\n                        const formGroup = inputs[i].closest('.form-group');\n                        formGroup.classList.add('error');\n                    }\n                }\n                \n                if (inputs[i].id === 'telefono_cliente') {\n                    const telefonoLimpio = inputs[i].value.replace(/\\D/g, '');\n                    if (telefonoLimpio.length < 10) {\n                        valid = false;\n                        const formGroup = inputs[i].closest('.form-group');\n                        formGroup.classList.add('error');\n                    }\n                }\n            }\n\n            if (!valid) {\n                // Scroll al primer error\n                const firstError = steps[n].querySelector('.form-group.error');\n                if (firstError) {\n                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                }\n            }\n\n            return valid;\n        }\n\n        function updateStepIndicator(n) {\n            const steps = document.getElementsByClassName(\"step\");\n            for (let i = 0; i < steps.length; i++) {\n                steps[i].className = steps[i].className.replace(\" active\", \"\");\n                if (i < n) {\n                    steps[i].className += \" completed\";\n                } else {\n                    steps[i].className = steps[i].className.replace(\" completed\", \"\");\n                }\n            }\n            steps[n].className += \" active\";\n        }\n        // ========================================\n        // FONDOS Y SLOGANS DIN√ÅMICOS\n        // ========================================\n\n        const eventosInfo = {\n            \"Eventos sociales\": {\n                imagen: \"https://images.unsplash.com/photo-1511795409834-ef04bbd61622?auto=format&fit=crop&q=80\",\n                slogan: \"Celebra la vida <br><span>sin l√≠mites</span>\",\n                subSlogan: \"Bodas, cumplea√±os y reuniones familiares. Llevamos la emoci√≥n de tu celebraci√≥n a quienes no pudieron asistir.\"\n            },\n            \"Conferencias y eventos corporativos\": {\n                imagen: \"https://images.unsplash.com/photo-1544531586-fde5298cdd40?auto=format&fit=crop&q=80\",\n                slogan: \"Conecta con tu <br><span>audiencia global</span>\",\n                subSlogan: \"Streaming profesional para conferencias, lanzamientos y seminarios. Calidad broadcast para tu marca.\"\n            },\n            \"E-Sport y Gaming\": {\n                imagen: \"https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80\",\n                slogan: \"Sube de nivel <br><span>tu transmisi√≥n</span>\",\n                subSlogan: \"Captura cada jugada con la m√°xima intensidad. Producci√≥n especializada para torneos y eventos gaming.\"\n            },\n            \"Conciertos y Eventos Art√≠sticos\": {\n                imagen: \"https://images.unsplash.com/photo-1501386761578-eac5c94b800a?auto=format&fit=crop&q=80\",\n                slogan: \"El escenario <br><span>en todas partes</span>\",\n                subSlogan: \"M√∫sica y arte en alta definici√≥n. Haz que tus fans sientan la energ√≠a como si estuvieran en primera fila.\"\n            },\n            \"Eventos Religiosos\": {\n                imagen: \"https://images.unsplash.com/photo-1438232992991-995b7058bbb3?auto=format&fit=crop&q=80\",\n                slogan: \"Comparte tu <br><span>mensaje de fe</span>\",\n                subSlogan: \"Lleva tus servicios y ceremonias a toda tu comunidad, sin importar d√≥nde se encuentren.\"\n            },\n            \"Eventos Deportivos\": {\n                imagen: \"https://images.unsplash.com/photo-1461896836934-ffe607ba8211?auto=format&fit=crop&q=80\",\n                slogan: \"Cada gol, <br><span>en tiempo real</span>\",\n                subSlogan: \"Cobertura din√°mica para deportes. Repeticiones, marcadores y la mejor acci√≥n en vivo.\"\n            },\n            \"default\": {\n                imagen: \"https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&q=80\",\n                slogan: \"Conserva tus <br><span>mejores momentos</span>\",\n                subSlogan: \"La distancia es solo f√≠sica. Ofrecemos servicios de streaming profesional multic√°mara para que nadie se pierda tu celebraci√≥n.\"\n            }\n        };\n\n        // Funci√≥n para actualizar el fondo y textos\n        function updateBackground(tipoEvento) {\n            const info = eventosInfo[tipoEvento] || eventosInfo[\"default\"];\n            const body = document.body;\n            const slogan = document.getElementById('dynamicSlogan');\n            const subSlogan = document.getElementById('dynamicSubSlogan');\n\n            // Efecto de transici√≥n simple cambiando la URL\n            // La transici√≥n CSS en el body se encargar√° del suavizado\n            body.style.backgroundImage = `url('${info.imagen}')`;\n            \n            // Animaci√≥n de texto\n            slogan.style.opacity = '0';\n            subSlogan.style.opacity = '0';\n            \n            setTimeout(() => {\n                slogan.innerHTML = info.slogan;\n                subSlogan.textContent = info.subSlogan;\n                slogan.style.opacity = '1';\n                subSlogan.style.opacity = '1';\n            }, 300);\n        }\n\n        // Event listener para cambio de tipo de evento\n        document.getElementById('tipo_evento').addEventListener('change', function() {\n            renderizarCamposDinamicos(this.value);\n            updateBackground(this.value);\n        });\n\n        // Inicializar transiciones de texto\n        document.getElementById('dynamicSlogan').style.transition = 'opacity 0.3s ease';\n        document.getElementById('dynamicSubSlogan').style.transition = 'opacity 0.3s ease';\n\n    </script>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -992,
        624
      ],
      "id": "612d1e46-9991-46d5-a1f7-1762cd794ea5",
      "name": "fomularioWeb",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: calcularDias\n * ============================================\n * \n * PROP√ìSITO:\n * Calcula los d√≠as restantes hasta el evento y enriquece los datos\n * con informaci√≥n temporal para clasificaci√≥n posterior.\n * \n * INPUT (desde Webhook):\n * - body.fecha_evento: string (formato ISO: \"YYYY-MM-DD\")\n * \n * OUTPUT:\n * - Todos los campos del input original\n * - dias_del_evento: number - D√≠as restantes (puede ser negativo si ya pas√≥)\n * - timestamp_solicitud: string - ISO timestamp de cuando se proces√≥\n * - fecha_procesamiento: string - Fecha legible en espa√±ol (zona horaria Venezuela)\n * \n * MANEJO DE ERRORES:\n * - Valida que fecha_evento exista y sea v√°lida\n * - Maneja fechas pasadas (d√≠as negativos)\n * \n * AUTOR: Live Moments Team\n * √öLTIMA ACTUALIZACI√ìN: 2025-12-03\n */\n\n// ============================================\n// CONFIGURACI√ìN Y CONSTANTES\n// ============================================\n\nconst CONFIG = {\n  // Zona horaria de Venezuela (UTC-4)\n  TIMEZONE: 'America/Caracas',\n  \n  // Locale para formateo de fechas en espa√±ol\n  LOCALE: 'es-ES',\n  \n  // Opciones de formateo de fecha\n  FORMATO_FECHA: {\n    timeZone: 'America/Caracas',\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit'\n  },\n  \n  // Milisegundos en un d√≠a (para c√°lculos)\n  MS_POR_DIA: 1000 * 60 * 60 * 24\n};\n\n// ============================================\n// FUNCIONES AUXILIARES\n// ============================================\n\n/**\n * Valida que una fecha sea v√°lida\n * @param {Date} fecha - Objeto Date a validar\n * @returns {boolean} true si la fecha es v√°lida\n */\nfunction esFechaValida(fecha) {\n  return fecha instanceof Date && !isNaN(fecha.getTime());\n}\n\n/**\n * Parsea una fecha en formato string a objeto Date\n * @param {string} fechaString - Fecha en formato \"YYYY-MM-DD\"\n * @returns {Date} Objeto Date\n * @throws {Error} Si la fecha no es v√°lida\n */\nfunction parsearFecha(fechaString) {\n  if (!fechaString || typeof fechaString !== 'string') {\n    throw new Error(`Fecha inv√°lida: se esperaba un string, se recibi√≥ ${typeof fechaString}`);\n  }\n  \n  const fecha = new Date(fechaString);\n  \n  if (!esFechaValida(fecha)) {\n    throw new Error(`Fecha inv√°lida: \"${fechaString}\" no es una fecha v√°lida`);\n  }\n  \n  return fecha;\n}\n\n/**\n * Calcula la diferencia en d√≠as entre dos fechas\n * @param {Date} fechaFutura - Fecha del evento\n * @param {Date} fechaActual - Fecha actual\n * @returns {number} D√≠as de diferencia (puede ser negativo si el evento ya pas√≥)\n */\nfunction calcularDiferenciaDias(fechaFutura, fechaActual) {\n  // Normalizar ambas fechas a medianoche para comparaci√≥n precisa\n  const fechaFuturaNormalizada = new Date(fechaFutura);\n  fechaFuturaNormalizada.setHours(0, 0, 0, 0);\n  \n  const fechaActualNormalizada = new Date(fechaActual);\n  fechaActualNormalizada.setHours(0, 0, 0, 0);\n  \n  // Calcular diferencia en milisegundos\n  const diferenciaMilisegundos = fechaFuturaNormalizada - fechaActualNormalizada;\n  \n  // Convertir a d√≠as (redondear hacia arriba para ser conservadores)\n  const dias = Math.ceil(diferenciaMilisegundos / CONFIG.MS_POR_DIA);\n  \n  return dias;\n}\n\n/**\n * Formatea una fecha a string legible en espa√±ol\n * @param {Date} fecha - Fecha a formatear\n * @returns {string} Fecha formateada (ej: \"03/12/2025 13:45:30\")\n */\nfunction formatearFechaLegible(fecha) {\n  return fecha.toLocaleString(CONFIG.LOCALE, CONFIG.FORMATO_FECHA);\n}\n\n/**\n * Genera metadata adicional sobre el c√°lculo\n * @param {number} dias - D√≠as calculados\n * @param {Date} fechaEvento - Fecha del evento\n * @param {Date} fechaActual - Fecha actual\n * @returns {Object} Metadata con informaci√≥n adicional\n */\nfunction generarMetadata(dias, fechaEvento, fechaActual) {\n  return {\n    dias_calculados: dias,\n    fecha_evento_iso: fechaEvento.toISOString(),\n    fecha_calculo_iso: fechaActual.toISOString(),\n    evento_en_pasado: dias < 0,\n    semanas_restantes: Math.floor(dias / 7),\n    meses_restantes: Math.floor(dias / 30)\n  };\n}\n\n// ============================================\n// L√ìGICA PRINCIPAL\n// ============================================\n\ntry {\n  // Obtener datos del input (Webhook env√≠a datos en .body)\n  const input = $input.item.json.body;\n  \n  // Validar que tenemos los datos necesarios\n  if (!input) {\n    throw new Error('No se recibieron datos del webhook');\n  }\n  \n  if (!input.fecha_evento) {\n    throw new Error('El campo \"fecha_evento\" es requerido');\n  }\n  \n  // Parsear fecha del evento\n  const fechaEvento = parsearFecha(input.fecha_evento);\n  \n  // Obtener fecha actual\n  const fechaActual = new Date();\n  \n  // Calcular d√≠as restantes\n  const diasRestantes = calcularDiferenciaDias(fechaEvento, fechaActual);\n  \n  // Generar timestamps\n  const timestampSolicitud = fechaActual.toISOString();\n  const fechaProcesamiento = formatearFechaLegible(fechaActual);\n  \n  // Generar metadata (opcional, √∫til para debugging)\n  const metadata = generarMetadata(diasRestantes, fechaEvento, fechaActual);\n  \n  // Logging para debugging (visible en ejecuci√≥n de N8N)\n  console.log(`üìÖ Evento: ${input.fecha_evento}`);\n  console.log(`‚è∞ D√≠as restantes: ${diasRestantes}`);\n  console.log(`üïê Procesado: ${fechaProcesamiento}`);\n  \n  // Advertencia si el evento ya pas√≥\n  if (diasRestantes < 0) {\n    console.warn(`‚ö†Ô∏è ADVERTENCIA: El evento ya pas√≥ (hace ${Math.abs(diasRestantes)} d√≠as)`);\n  }\n  \n  // Retornar datos enriquecidos\n  return {\n    ...input,\n    dias_del_evento: diasRestantes,\n    timestamp_solicitud: timestampSolicitud,\n    fecha_procesamiento: fechaProcesamiento,\n    // Metadata adicional (comentar si no se necesita)\n    _metadata_calculo: metadata\n  };\n  \n} catch (error) {\n  // Manejo de errores robusto\n  console.error('‚ùå Error en calcularDias:', error.message);\n  \n  // Re-lanzar el error para que N8N lo maneje\n  // (esto har√° que el workflow tome la rama de error si est√° configurada)\n  throw new Error(`Error calculando d√≠as del evento: ${error.message}`);\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        -80
      ],
      "id": "d56ee1e1-7191-4bea-a19b-59b6578ac235",
      "name": "calcularDias"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: clasificarUrgencia\n * ============================================\n * \n * PROP√ìSITO:\n * Clasifica la urgencia de una solicitud de evento seg√∫n m√∫ltiples criterios\n * de negocio para priorizar el seguimiento comercial.\n * \n * INPUT (desde nodo anterior):\n * - dias_del_evento: number - D√≠as restantes hasta el evento\n * - paquete_interes: string - Paquete seleccionado por el cliente\n * - tipo_evento: string - Categor√≠a del evento\n * \n * OUTPUT:\n * - nivel_urgencia: string - Descripci√≥n del nivel (ej: \"üî¥ ALTA (Menos de 1 semana)\")\n * - emoji_urgencia: string - Emoji visual para identificaci√≥n r√°pida\n * \n * L√ìGICA DE CLASIFICACI√ìN:\n * 1. ALTA (üî¥): Eventos pr√≥ximos (<7 d√≠as), clientes Enterprise, corporativos urgentes\n * 2. MEDIA (üü°): Eventos cercanos (<30 d√≠as), paquetes Premium\n * 3. NORMAL (üü¢): Resto de casos\n * \n * AUTOR: Live Moments Team\n * √öLTIMA ACTUALIZACI√ìN: 2025-12-03\n */\n\n// ============================================\n// CONFIGURACI√ìN Y CONSTANTES\n// ============================================\n\nconst CONFIG = {\n  // Umbrales de d√≠as para clasificaci√≥n\n  UMBRALES_DIAS: {\n    ALTA_URGENCIA: 7,\n    MEDIA_URGENCIA: 30,\n    CORPORATIVO_URGENTE: 14\n  },\n  \n  // Tipos de paquetes\n  PAQUETES: {\n    BASICO: 'B√°sico',\n    ESTANDAR: 'Est√°ndar',\n    PREMIUM: 'Premium',\n    ENTERPRISE: 'Enterprise'\n  },\n  \n  // Tipos de eventos especiales\n  EVENTOS_ESPECIALES: {\n    CORPORATIVO: 'Conferencias y eventos corporativos'\n  },\n  \n  // Niveles de urgencia\n  NIVELES: {\n    ALTA: {\n      emoji: 'üî¥',\n      prefijo: 'üî¥ ALTA'\n    },\n    MEDIA: {\n      emoji: 'üü°',\n      prefijo: 'üü° MEDIA'\n    },\n    NORMAL: {\n      emoji: 'üü¢',\n      prefijo: 'üü¢ Normal'\n    }\n  }\n};\n\n// ============================================\n// FUNCIONES AUXILIARES\n// ============================================\n\n/**\n * Determina si el evento es de tipo corporativo\n * @param {string} tipoEvento - Tipo de evento\n * @returns {boolean}\n */\nfunction esCorporativo(tipoEvento) {\n  return tipoEvento === CONFIG.EVENTOS_ESPECIALES.CORPORATIVO;\n}\n\n/**\n * Determina si el paquete es Enterprise\n * @param {string} paquete - Paquete seleccionado\n * @returns {boolean}\n */\nfunction esEnterprise(paquete) {\n  return paquete === CONFIG.PAQUETES.ENTERPRISE;\n}\n\n/**\n * Determina si el paquete es Premium\n * @param {string} paquete - Paquete seleccionado\n * @returns {boolean}\n */\nfunction esPremium(paquete) {\n  return paquete === CONFIG.PAQUETES.PREMIUM;\n}\n\n/**\n * Clasifica la urgencia seg√∫n d√≠as restantes\n * @param {number} dias - D√≠as hasta el evento\n * @param {string} paquete - Paquete seleccionado\n * @param {string} tipoEvento - Tipo de evento\n * @returns {Object} {nivel, emoji, razon}\n */\nfunction clasificarPorCriterios(dias, paquete, tipoEvento) {\n  // CRITERIO 1: Menos de 7 d√≠as (ALTA URGENCIA)\n  if (dias < CONFIG.UMBRALES_DIAS.ALTA_URGENCIA) {\n    return {\n      nivel: CONFIG.NIVELES.ALTA.prefijo,\n      emoji: CONFIG.NIVELES.ALTA.emoji,\n      razon: 'Menos de 1 semana'\n    };\n  }\n  \n  // CRITERIO 2: Cliente Enterprise (ALTA URGENCIA)\n  if (esEnterprise(paquete)) {\n    return {\n      nivel: CONFIG.NIVELES.ALTA.prefijo,\n      emoji: 'üíé', // Emoji especial para Enterprise\n      razon: 'Cliente Enterprise'\n    };\n  }\n  \n  // CRITERIO 3: Evento corporativo pr√≥ximo (ALTA URGENCIA)\n  if (esCorporativo(tipoEvento) && dias < CONFIG.UMBRALES_DIAS.CORPORATIVO_URGENTE) {\n    return {\n      nivel: CONFIG.NIVELES.ALTA.prefijo,\n      emoji: 'üè¢', // Emoji especial para corporativo\n      razon: 'Corporativo pr√≥ximo'\n    };\n  }\n  \n  // CRITERIO 4: Menos de 30 d√≠as (MEDIA URGENCIA)\n  if (dias < CONFIG.UMBRALES_DIAS.MEDIA_URGENCIA) {\n    return {\n      nivel: CONFIG.NIVELES.MEDIA.prefijo,\n      emoji: CONFIG.NIVELES.MEDIA.emoji,\n      razon: 'Menos de 1 mes'\n    };\n  }\n  \n  // CRITERIO 5: Paquete Premium (MEDIA URGENCIA)\n  if (esPremium(paquete)) {\n    return {\n      nivel: CONFIG.NIVELES.MEDIA.prefijo,\n      emoji: '‚≠ê', // Emoji especial para Premium\n      razon: 'Paquete Premium'\n    };\n  }\n  \n  // CRITERIO 6: Resto de casos (NORMAL)\n  return {\n    nivel: CONFIG.NIVELES.NORMAL.prefijo,\n    emoji: CONFIG.NIVELES.NORMAL.emoji,\n    razon: 'Tiempo suficiente'\n  };\n}\n\n// ============================================\n// L√ìGICA PRINCIPAL\n// ============================================\n\n// Obtener datos del input\nconst input = $input.item.json;\n\n// Extraer variables necesarias\nconst dias = input.dias_del_evento;\nconst paquete = input.paquete_interes;\nconst tipoEvento = input.tipo_evento;\n\n// Validar que tenemos los datos necesarios\nif (typeof dias !== 'number' || !paquete || !tipoEvento) {\n  throw new Error('Faltan datos requeridos para clasificar urgencia');\n}\n\n// Clasificar urgencia\nconst clasificacion = clasificarPorCriterios(dias, paquete, tipoEvento);\n\n// Construir descripci√≥n completa\nconst urgenciaCompleta = `${clasificacion.nivel} (${clasificacion.razon})`;\n\n// Retornar datos enriquecidos\nreturn {\n  ...input,\n  nivel_urgencia: urgenciaCompleta,\n  emoji_urgencia: clasificacion.emoji,\n  // Campos adicionales para debugging/analytics\n  _metadata: {\n    dias_clasificacion: dias,\n    criterio_aplicado: clasificacion.razon,\n    timestamp_clasificacion: new Date().toISOString()\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -768,
        -80
      ],
      "id": "23ef9cd6-c125-438c-8f71-f19efa91d275",
      "name": "clasificarUrgencia"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: validarDatos\n * ============================================\n * \n * PROP√ìSITO:\n * Transforma los datos recolectados por el bot de Telegram al formato\n * esperado por el flujo central (webhook), asegurando compatibilidad.\n * \n * INPUT (desde routerAccion):\n * - update_data: Objeto con los datos recolectados por el bot\n *   - tipo_evento: string\n *   - fecha_evento: string (formato DD/MM/YYYY)\n *   - ubicacion_evento: string\n *   - paquete_interes: string\n *   - nombre_cliente: string\n *   - email_cliente: string\n *   - telefono_cliente: string\n * \n * OUTPUT:\n * - Objeto compatible con el webhook del flujo central\n */\n\n// ============================================\n// CONFIGURACI√ìN\n// ============================================\n\nconst CONFIG = {\n  TIMEZONE: 'America/Caracas',\n  // ORIGEN ahora se determina din√°micamente\n  ORIGENES_VALIDOS: ['telegram', 'whatsapp', 'webhook'],\n  CAMPOS_REQUERIDOS: [\n    'tipo_evento',\n    'fecha_evento',\n    'ubicacion_evento',\n    'paquete_interes',\n    'nombre_cliente',\n    'email_cliente',\n    'telefono_cliente'\n  ],\n  // Valores por defecto para campos opcionales\n  DEFAULTS: {\n    duracion_estimada: 'Por confirmar',\n    tiene_internet_venue: 'No estoy seguro',\n    comentarios_adicionales: 'Solicitud desde Telegram Bot',\n    add_ons_solicitados: []\n  }\n};\n\n// ============================================\n// FUNCIONES AUXILIARES\n// ============================================\n\n/**\n * Convierte fecha de DD/MM/YYYY a YYYY-MM-DD\n * @param {string} fechaDDMMYYYY - Fecha en formato DD/MM/YYYY\n * @returns {string} Fecha en formato YYYY-MM-DD\n */\nfunction convertirFecha(fechaDDMMYYYY) {\n  if (!fechaDDMMYYYY) return null;\n  \n  // Si ya est√° en formato YYYY-MM-DD, retornar tal cual\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(fechaDDMMYYYY)) {\n    return fechaDDMMYYYY;\n  }\n  \n  // Convertir DD/MM/YYYY a YYYY-MM-DD\n  const partes = fechaDDMMYYYY.split('/');\n  if (partes.length === 3) {\n    const [dia, mes, anio] = partes;\n    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n  }\n  \n  return fechaDDMMYYYY; // Retornar original si no se puede convertir\n}\n\n/**\n * Valida que los campos requeridos existan\n * @param {Object} datos - Datos a validar\n * @returns {Object} {valido: boolean, faltantes: string[]}\n */\nfunction validarCamposRequeridos(datos) {\n  const faltantes = CONFIG.CAMPOS_REQUERIDOS.filter(\n    campo => !datos[campo] || datos[campo] === 'undefined'\n  );\n  \n  return {\n    valido: faltantes.length === 0,\n    faltantes\n  };\n}\n\n/**\n * Limpia valores undefined o null\n * @param {*} valor - Valor a limpiar\n * @param {*} valorDefault - Valor por defecto si es undefined/null\n * @returns {*} Valor limpio\n */\nfunction limpiarValor(valor, valorDefault = '') {\n  if (valor === undefined || valor === null || valor === 'undefined') {\n    return valorDefault;\n  }\n  return valor;\n}\n\n// ============================================\n// L√ìGICA PRINCIPAL\n// ============================================\n\n// Obtener datos del input\nconst input = $input.item.json;\nconst datosBot = input.update_data || input;\nconst chatId = input.chat_id || $('telegramTrigger').first().json.message?.chat?.id || \n               $('telegramTrigger').first().json.callback_query?.message?.chat?.id;\n\n// Validar campos requeridos\nconst validacion = validarCamposRequeridos(datosBot);\n\nif (!validacion.valido) {\n  console.warn('‚ö†Ô∏è Campos faltantes:', validacion.faltantes.join(', '));\n}\n\n// Construir payload compatible con webhook\nconst payloadWebhook = {\n  // Campos principales (del bot)\n  tipo_evento: limpiarValor(datosBot.tipo_evento),\n  fecha_evento: convertirFecha(datosBot.fecha_evento),\n  ubicacion_evento: limpiarValor(datosBot.ubicacion_evento),\n  paquete_interes: limpiarValor(datosBot.paquete_interes),\n  nombre_cliente: limpiarValor(datosBot.nombre_cliente),\n  email_cliente: limpiarValor(datosBot.email_cliente),\n  telefono_cliente: limpiarValor(datosBot.telefono_cliente),\n  \n  // Campos con valores por defecto\n  duracion_estimada: limpiarValor(datosBot.duracion_estimada, CONFIG.DEFAULTS.duracion_estimada),\n  tiene_internet_venue: limpiarValor(datosBot.tiene_internet_venue, CONFIG.DEFAULTS.tiene_internet_venue),\n  comentarios_adicionales: limpiarValor(datosBot.comentarios_adicionales, CONFIG.DEFAULTS.comentarios_adicionales),\n  add_ons_solicitados: datosBot.add_ons_solicitados || CONFIG.DEFAULTS.add_ons_solicitados,\n  \n  // Metadatos de origen (din√°mico seg√∫n el canal)\n  origen: datosBot.origen || 'telegram',  // telegram | whatsapp | webhook\n  chat_id: chatId,\n  timestamp: new Date().toISOString(),\n  \n  // Flag de validaci√≥n\n  datos_completos: validacion.valido,\n  campos_faltantes: validacion.faltantes,\n  requiere_revision: datosBot.revision_manual || !validacion.valido\n};\n\n// Logging para debugging\nconsole.log('üì§ Payload transformado para flujo central:');\nconsole.log(JSON.stringify(payloadWebhook, null, 2));\n\nreturn payloadWebhook;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        -80
      ],
      "id": "3487ee89-d65a-4880-8f07-acb190a756d1",
      "name": "validarDatos"
    },
    {
      "parameters": {
        "content": "## Envio de los datos al formulario",
        "height": 208,
        "width": 400,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1232,
        560
      ],
      "typeVersion": 1,
      "id": "5c53e452-3f21-4339-a3fb-1dd729c2a954",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Clasificacion del mensaje ##                          ",
        "height": 208,
        "width": 1088
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1264,
        -128
      ],
      "typeVersion": 1,
      "id": "e1aea40d-a5ba-421f-8c64-161a7e1b6d62",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Datos invalidos",
        "height": 240,
        "width": 832,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        160,
        256
      ],
      "typeVersion": 1,
      "id": "83367c48-c634-40fa-ad5c-1b45934c7d4c",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Datos validos",
        "height": 400,
        "width": 2224,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        80,
        -224
      ],
      "typeVersion": 1,
      "id": "7124793a-7b47-44d2-ae36-6fcbf01aa7e0",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"nombre_cliente\": \"{{ $json.nombre_cliente }}\",\n  \"email_cliente\": \"{{ $json.email_cliente }}\",\n  \"telefono_cliente\": \"{{ $json.telefono_cliente }}\",\n  \"tipo_evento\": \"{{ $json.tipo_evento }}\",\n  \"fecha_evento\": \"{{ $json.fecha_evento }}\",\n  \"ubicacion_evento\": \"{{ $json.ubicacion_evento }}\",\n  \"duracion_estimada\": \"{{ $json.duracion_estimada }}\",\n  \"tiene_internet_venue\": \"{{ $json.tiene_internet_venue }}\",\n  \"paquete_interes\": \"{{ $json.paquete_interes }}\",\n  \"add_ons_solicitados\": {{ JSON.stringify($json.add_ons_solicitados) }},\n  \"comentarios_adicionales\": {{ JSON.stringify($json.comentarios_adicionales) }},\n  \"dias_del_evento\": {{ $json.dias_del_evento }},\n  \"nivel_urgencia\": \"{{ $json.nivel_urgencia }}\",\n  \"emoji_urgencia\": \"{{ $json.emoji_urgencia }}\",\n  \"timestamp_solicitud\": \"{{ $json.timestamp_solicitud }}\",\n  \"fecha_procesamiento\": \"{{ $json.fecha_procesamiento }}\",\n  \"tipo_celebracion\": \"{{ $json.tipo_celebracion}}\",\n  \"numero_invitados\": {{ $json.numero_invitados || null }},\n  \"momentos_clave\": {{ JSON.stringify($json.momentos_clave) || null }},\n  \"nombre_empresa\": \"{{ $json.nombre_empresa || null}}\",\n  \"tipo_conferencia\": \"{{ $json.tipo_conferencia || null}}\",\n  \"numero_speakers\": {{ $json.numero_speakers || 1 }},\n  \"numero_asistentes\": {{ $json.numero_asistentes || 1 }},\n  \"necesita_grabacion\": \"{{ $json.necesita_grabacion || null }}\",\n  \"plataformas_destino\": {{ JSON.stringify($json.plataformas_destino) || null }},\n  \"juego_plataforma\": \"{{ $json.juego_plataforma || null }}\",\n  \"tipo_torneo\": \"{{ $json.tipo_torneo || null }}\",\n  \"numero_equipos\": {{ $json.numero_equipos || null }},\n  \"numero_jugadores\": {{ $json.numero_jugadores || null }},\n  \"necesita_scoreboards\": \"{{ $json.necesita_scoreboards || null }}\",\n  \"necesita_comentaristas\": \"{{ $json.necesita_comentaristas || null }}\",\n  \"tipo_evento_artistico\": \"{{ $json.tipo_evento_artistico || null }}\",\n  \"nombre_artista\": \"{{ $json.nombre_artista || null }}\",\n  \"numero_artistas\": {{ $json.numero_artistas || null }},\n  \"tipo_venue\": \"{{ $json.tipo_venue || null }}\",\n  \"necesita_audio_profesional\": \"{{ $json.necesita_audio_profesional || null }}\",\n  \"tipo_ceremonia\": \"{{ $json.tipo_ceremonia || null }}\",\n  \"necesita_audio_claro\": \"{{ $json.necesita_audio_claro || null }}\",\n  \"tipo_deporte\": \"{{ $json.tipo_deporte || null  }}\",\n  \"tipo_evento_deportivo\": \"{{ $json.tipo_evento_deportivo || null }}\",\n  \"necesita_replays\": \"{{ $json.necesita_replays || null }}\",\n  \"tipo_venue_deportivo\": \"{{ $json.tipo_venue_deportivo || null }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -320,
        -80
      ],
      "id": "2172182b-2cb4-45ad-a107-1a5aed38391d",
      "name": "formularioValido"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "10rXdCRUcdRiBwCNr430Qb5lomSx48Hb4laSSstymL1s",
          "mode": "list",
          "cachedResultName": "Registro de Errores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/10rXdCRUcdRiBwCNr430Qb5lomSx48Hb4laSSstymL1s/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/10rXdCRUcdRiBwCNr430Qb5lomSx48Hb4laSSstymL1s/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Nombre completo": "={{ $('formularioValido').item.json.nombre_cliente }}",
            "Correo electr√≥nico": "={{ $('formularioValido').item.json.email_cliente }}",
            "N√∫mero de contacto": "={{ $('formularioValido').item.json.telefono_cliente }}",
            "Categor√≠a del evento": "={{ $('formularioValido').item.json.tipo_evento }}",
            "Fecha programada": "={{ $('formularioValido').item.json.fecha_evento }}",
            "Fecha y hora del error": "={{ $now }}",
            "Lugar del evento": "={{ $('formularioValido').item.json.ubicacion_evento }}",
            "Duraci√≥n estimada": "={{ $('formularioValido').item.json.duracion_estimada }}",
            "Disponibilidad de internet": "={{ $('formularioValido').item.json.tiene_internet_venue }}",
            "Paquete seleccionado": "={{ $('formularioValido').item.json.paquete_interes }}",
            "Servicios adicionales": "={{ $('formularioValido').item.json.add_ons_solicitados }}",
            "Nivel de urgencia": "={{ $('formularioValido').item.json.nivel_urgencia }}",
            "Pendiente/Contactado/Resuelto": "Pendiente",
            "Categor√≠a del error": "Hay datos inv√°lidos",
            "Detalle del error": "Faltan datos validos"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Fecha y hora del error",
              "displayName": "Fecha y hora del error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Nombre completo",
              "displayName": "Nombre completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Correo electr√≥nico",
              "displayName": "Correo electr√≥nico",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "N√∫mero de contacto",
              "displayName": "N√∫mero de contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Categor√≠a del evento",
              "displayName": "Categor√≠a del evento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fecha programada",
              "displayName": "Fecha programada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Lugar del evento",
              "displayName": "Lugar del evento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Duraci√≥n estimada",
              "displayName": "Duraci√≥n estimada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Disponibilidad de internet",
              "displayName": "Disponibilidad de internet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Paquete seleccionado",
              "displayName": "Paquete seleccionado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Servicios adicionales",
              "displayName": "Servicios adicionales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Categor√≠a del error",
              "displayName": "Categor√≠a del error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Detalle del error",
              "displayName": "Detalle del error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Nivel de urgencia",
              "displayName": "Nivel de urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Pendiente/Contactado/Resuelto",
              "displayName": "Pendiente/Contactado/Resuelto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        480,
        304
      ],
      "id": "32ceaf8c-7e13-4a52-a5c3-5098dd183aaa",
      "name": "registroErrores",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "pn9KPrV0bTFz3NPp",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        704,
        304
      ],
      "id": "a2fcc190-4bb3-457a-90f1-f56257482359",
      "name": "responderCode400"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// NODO CODE - Procesar Respuesta del AI Agent\n// ============================================\n// Este nodo va DESPU√âS del AI Agent y ANTES de Gmail\n// Obtener la respuesta del AI Agent\nconst aiOutput = $input.item.json.output;\n// Obtener datos originales del formulario\nconst formData = $('formularioValido').item.json;\n// ============================================\n// 1. CONVERTIR ADD-ONS A HTML\n// ============================================\nlet addonsHTML = '';\nif (aiOutput.recomendaciones.addons && aiOutput.recomendaciones.addons.length > 0) {\n  addonsHTML = aiOutput.recomendaciones.addons\n    .map(addon => `<li>${addon}</li>`)\n    .join('');\n} else {\n  // Si no hay add-ons, mostrar mensaje\n  addonsHTML = '<li>No hay recomendaciones adicionales en este momento.</li>';\n}\n// ============================================\n// 2. CONVERTIR PR√ìXIMOS PASOS A HTML\n// ============================================\nconst proximosPasosHTML = aiOutput.proximos_pasos\n  .map((paso, index) => `\n    <tr>\n      <td style=\"padding: 12px 0; border-bottom: 1px solid #eeeeee;\">\n        <table width=\"100%\">\n          <tr>\n            <td width=\"40\" style=\"vertical-align: top;\">\n              <div style=\"width: 32px; height: 32px; background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%); border-radius: 50%; color: white; font-weight: 700; font-size: 14px; text-align: center; line-height: 32px;\">\n                ${index + 1}\n              </div>\n            </td>\n            <td style=\"color: #555555; font-size: 14px; line-height: 1.6; padding-left: 10px;\">\n              ${paso}\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  `)\n  .join('');\n// ============================================\n// 3. GENERAR HTML PARA RECOMENDACI√ìN DE PAQUETE\n// ============================================\nlet paqueteHTML = '';\nif (aiOutput.recomendaciones.paquete) {\n  paqueteHTML = `\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #E8F5E9; border-left: 4px solid #4CAF50; border-radius: 4px; margin-bottom: 15px;\">\n      <tr>\n        <td style=\"padding: 15px 20px;\">\n          <p style=\"margin: 0; color: #2E7D32; font-size: 14px; line-height: 1.6;\">\n            <strong>üì¶ Sobre tu paquete:</strong><br>\n            ${aiOutput.recomendaciones.paquete}\n          </p>\n        </td>\n      </tr>\n    </table>\n  `;\n}\n// ============================================\n// 4. GENERAR HTML PARA CONSIDERACIONES\n// ============================================\nlet consideracionesHTML = '';\nif (aiOutput.recomendaciones.consideraciones) {\n  consideracionesHTML = `\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 4px; margin-bottom: 25px;\">\n      <tr>\n        <td style=\"padding: 15px 20px;\">\n          <p style=\"margin: 0; color: #1565C0; font-size: 14px; line-height: 1.6;\">\n            <strong>‚ÑπÔ∏è Importante:</strong><br>\n            ${aiOutput.recomendaciones.consideraciones}\n          </p>\n        </td>\n      </tr>\n    </table>\n  `;\n}\n// ============================================\n// 5. RETORNAR DATOS PROCESADOS\n// ============================================\nreturn {\n  // Datos del AI procesados\n  asunto: aiOutput.asunto,\n  saludo: aiOutput.saludo,\n  parrafo_confirmacion: aiOutput.parrafo_confirmacion,\n  despedida: aiOutput.despedida,\n  tono_detectado: aiOutput.tono_detectado,\n  \n  // HTML generado\n  paquete_html: paqueteHTML,\n  addons_html: addonsHTML,\n  consideraciones_html: consideracionesHTML,\n  proximos_pasos_html: proximosPasosHTML,\n  \n  // Datos originales del formulario (para el resumen)\n  nombre_cliente: formData.nombre_cliente,\n  email_cliente: formData.email_cliente,\n  tipo_evento: formData.tipo_evento,\n  fecha_evento: formData.fecha_evento,\n  ubicacion_evento: formData.ubicacion_evento,\n  paquete_interes: formData.paquete_interes,\n  \n  // Datos completos del AI (por si los necesitas)\n  ai_response_completo: aiOutput\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        -208
      ],
      "id": "c7f53bfd-32a7-4ae0-a4d6-224a0cc273d4",
      "name": "procesarRespuesta"
    },
    {
      "parameters": {
        "sendTo": "=Erjgomezf@gmail.com",
        "subject": "=ERROR - {{ $json.tipo_evento }}",
        "message": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Error en Formulario - Seguimiento Requerido</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4;\">\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f4f4f4; padding: 20px;\">\n        <tr>\n            <td align=\"center\">\n                <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\n                    \n                    <!-- Header -->\n                    <tr>\n                        <td style=\"background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%); padding: 30px 40px; text-align: center;\">\n                            <h1 style=\"margin: 0; color: #ffffff; font-size: 24px; font-weight: 600;\">\n                                ‚ö†Ô∏è Seguimiento Requerido\n                            </h1>\n                            <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 14px; opacity: 0.9;\">\n                                Error detectado en formulario de cliente\n                            </p>\n                        </td>\n                    </tr>\n                    \n                    <!-- Content -->\n                    <tr>\n                        <td style=\"padding: 40px;\">\n                            \n                            <!-- Alert Box -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #FFF3CD; border-left: 4px solid #FFC107; border-radius: 4px; margin-bottom: 30px;\">\n                                <tr>\n                                    <td style=\"padding: 15px 20px;\">\n                                        <p style=\"margin: 0; color: #856404; font-size: 14px; line-height: 1.6;\">\n                                            <strong>‚ö†Ô∏è Acci√≥n Requerida:</strong> Se detect√≥ un error en el formulario. Por favor, contactar al cliente v√≠a telef√≥nica para completar la informaci√≥n.\n                                        </p>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Client Info -->\n                            <h2 style=\"margin: 0 0 20px 0; color: #333333; font-size: 18px; font-weight: 600; border-bottom: 2px solid #D4AF37; padding-bottom: 10px;\">\n                                üìã Informaci√≥n del Cliente\n                            </h2>\n                            \n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 30px;\">\n                                <tr>\n                                    <td style=\"padding: 12px 0; border-bottom: 1px solid #eeeeee;\">\n                                        <table width=\"100%\">\n                                            <tr>\n                                                <td width=\"140\" style=\"color: #666666; font-size: 14px; font-weight: 600;\">\n                                                    üë§ Nombre:\n                                                </td>\n                                                <td style=\"color: #333333; font-size: 14px;\">\n                                                    {{ $json.nombre_cliente }}\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 12px 0; border-bottom: 1px solid #eeeeee;\">\n                                        <table width=\"100%\">\n                                            <tr>\n                                                <td width=\"140\" style=\"color: #666666; font-size: 14px; font-weight: 600;\">\n                                                    üìß Email:\n                                                </td>\n                                                <td style=\"color: #333333; font-size: 14px;\">\n                                                    <a href=\"mailto:{{ $json.email_cliente }}\" style=\"color: #D4AF37; text-decoration: none;\">\n                                                        {{ $json.email_cliente }}\n                                                    </a>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 12px 0; border-bottom: 1px solid #eeeeee;\">\n                                        <table width=\"100%\">\n                                            <tr>\n                                                <td width=\"140\" style=\"color: #666666; font-size: 14px; font-weight: 600;\">\n                                                    üìû Tel√©fono:\n                                                </td>\n                                                <td style=\"color: #333333; font-size: 14px; font-weight: 700;\">\n                                                    <a href=\"tel:{{ $json.telefono_cliente }}\" style=\"color: #28a745; text-decoration: none; font-size: 16px;\">\n                                                        {{ $json.telefono_cliente }}\n                                                    </a>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td style=\"padding: 12px 0;\">\n                                        <table width=\"100%\">\n                                            <tr>\n                                                <td width=\"140\" style=\"color: #666666; font-size: 14px; font-weight: 600;\">\n                                                    üéØ Tipo de Evento:\n                                                </td>\n                                                <td style=\"color: #333333; font-size: 14px;\">\n                                                    {{ $json.tipo_evento }}\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Error Summary -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #FFF5F5; border-left: 4px solid #DC3545; border-radius: 4px; margin-bottom: 30px;\">\n                                <tr>\n                                    <td style=\"padding: 15px 20px;\">\n                                        <p style=\"margin: 0 0 5px 0; color: #721C24; font-size: 13px; font-weight: 600;\">\n                                            ‚ùå Datos Validos:\n                                        </p>\n                                        <p style=\"margin: 0; color: #721C24; font-size: 13px; line-height: 1.5;\">\n                                            {{ $('validarDatos').item.json.datos_validos }}\n                                        </p>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Action Button -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px;\">\n                                <tr>\n                                    <td align=\"center\" style=\"padding: 20px 0;\">\n                                        <a href=\"https://docs.google.com/spreadsheets/d/TU_SHEET_ID\" \n                                           style=\"display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%); color: #ffffff; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 15px; box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);\">\n                                            üìä Ver Detalles Completos en Sheets\n                                        </a>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Instructions -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #E7F3FF; border-radius: 4px; border-left: 4px solid #2196F3;\">\n                                <tr>\n                                    <td style=\"padding: 15px 20px;\">\n                                        <p style=\"margin: 0 0 10px 0; color: #0D47A1; font-size: 13px; font-weight: 600;\">\n                                            üìû Pr√≥ximos Pasos:\n                                        </p>\n                                        <ol style=\"margin: 0; padding-left: 20px; color: #0D47A1; font-size: 13px; line-height: 1.8;\">\n                                            <li>Contactar al cliente por tel√©fono</li>\n                                            <li>Verificar y completar la informaci√≥n faltante</li>\n                                            <li>Actualizar el registro en Google Sheets</li>\n                                            <li>Procesar la solicitud manualmente si es necesario</li>\n                                        </ol>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                        </td>\n                    </tr>\n                    \n                    <!-- Footer -->\n                    <tr>\n                        <td style=\"background-color: #f8f9fa; padding: 20px 40px; text-align: center; border-top: 1px solid #eeeeee;\">\n                            <p style=\"margin: 0 0 5px 0; color: #666666; font-size: 12px;\">\n                                ü§ñ Este correo fue generado autom√°ticamente por el sistema de formularios\n                            </p>\n                            <p style=\"margin: 0; color: #999999; font-size: 11px;\">\n                                Fecha: {{ $now.format('DD/MM/YYYY HH:mm:ss') }}\n                            </p>\n                        </td>\n                    </tr>\n                    \n                </table>\n            </td>\n        </tr>\n    </table>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        192,
        304
      ],
      "id": "cd1c288d-6705-46d8-bffc-9f86fe9102a0",
      "name": "correoErrorSoporte",
      "webhookId": "d169cf78-7ade-4865-a8cd-bcd17e4ad059",
      "credentials": {
        "gmailOAuth2": {
          "id": "DtUkw6u9qFGHi6uQ",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "erjgomezf@gmail.com",
        "subject": "={{ $json.asunto }}",
        "message": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Confirmaci√≥n de Solicitud - Live Moments</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4;\">\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #f4f4f4; padding: 20px;\">\n        <tr>\n            <td align=\"center\">\n                <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\n                    \n                    <!-- Header -->\n                    <tr>\n                        <td style=\"background: linear-gradient(135deg, #D4AF37 0%, #C5A028 100%); padding: 40px; text-align: center;\">\n                            <h1 style=\"margin: 0; color: #ffffff; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">\n                                ‚ú® Live Moments\n                            </h1>\n                            <p style=\"margin: 10px 0 0 0; color: #ffffff; font-size: 15px; opacity: 0.95; font-weight: 500;\">\n                                Streaming Profesional Multic√°mara\n                            </p>\n                        </td>\n                    </tr>\n                    \n                    <!-- Success Badge -->\n                    <tr>\n                        <td align=\"center\" style=\"padding: 30px 40px 20px 40px;\">\n                            <div style=\"display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);\">\n                                ‚úì Solicitud Recibida Exitosamente\n                            </div>\n                        </td>\n                    </tr>\n                    \n                    <!-- Content -->\n                    <tr>\n                        <td style=\"padding: 0 40px 40px 40px;\">\n                            \n                            <!-- Saludo Personalizado (del AI) -->\n                            <p style=\"margin: 0 0 20px 0; color: #333333; font-size: 16px; line-height: 1.6;\">\n                                {{ $json.saludo }}\n                            </p>\n                            \n                            <!-- Confirmaci√≥n (del AI) -->\n                            <p style=\"margin: 0 0 30px 0; color: #555555; font-size: 15px; line-height: 1.7;\">\n                                {{ $json.parrafo_confirmacion }}\n                            </p>\n                            \n                            <!-- Resumen del Evento -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; margin-bottom: 30px; border: 1px solid #dee2e6;\">\n                                <tr>\n                                    <td style=\"padding: 20px;\">\n                                        <h3 style=\"margin: 0 0 15px 0; color: #D4AF37; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n                                            üìã Resumen de tu Solicitud\n                                        </h3>\n                                        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\n                                            <tr>\n                                                <td style=\"padding: 8px 0; color: #666666; font-size: 14px; width: 40%;\">\n                                                    <strong>Tipo de Evento:</strong>\n                                                </td>\n                                                <td style=\"padding: 8px 0; color: #333333; font-size: 14px;\">\n                                                    {{ $json.tipo_evento }}\n                                                </td>\n                                            </tr>\n                                            <tr>\n                                                <td style=\"padding: 8px 0; color: #666666; font-size: 14px;\">\n                                                    <strong>Fecha:</strong>\n                                                </td>\n                                                <td style=\"padding: 8px 0; color: #333333; font-size: 14px;\">\n                                                    {{ $json.fecha_evento }}\n                                                </td>\n                                            </tr>\n                                            <tr>\n                                                <td style=\"padding: 8px 0; color: #666666; font-size: 14px;\">\n                                                    <strong>Ubicaci√≥n:</strong>\n                                                </td>\n                                                <td style=\"padding: 8px 0; color: #333333; font-size: 14px;\">\n                                                    {{ $json.ubicacion_evento }}\n                                                </td>\n                                            </tr>\n                                            <tr>\n                                                <td style=\"padding: 8px 0; color: #666666; font-size: 14px;\">\n                                                    <strong>Paquete:</strong>\n                                                </td>\n                                                <td style=\"padding: 8px 0; color: #333333; font-size: 14px; font-weight: 600;\">\n                                                    {{ $json.paquete_interes }}\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Recomendaciones del AI -->\n                            <h3 style=\"margin: 0 0 15px 0; color: #333333; font-size: 18px; font-weight: 600; border-bottom: 2px solid #D4AF37; padding-bottom: 10px;\">\n                                üí° Recomendaciones Personalizadas\n                            </h3>\n                            \n                            <!-- Recomendaci√≥n de Paquete (HTML pre-generado) -->\n                            {{ $json.paquete_html }}\n                            \n                            <!-- Add-ons Recomendados (HTML pre-generado) -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color: #FFF3E0; border-left: 4px solid #FF9800; border-radius: 4px; margin-bottom: 15px;\">\n                                <tr>\n                                    <td style=\"padding: 15px 20px;\">\n                                        <p style=\"margin: 0 0 10px 0; color: #E65100; font-size: 14px; font-weight: 600;\">\n                                            ‚≠ê Servicios adicionales que podr√≠an interesarte:\n                                        </p>\n                                        <ul style=\"margin: 0; padding-left: 20px; color: #E65100; font-size: 13px; line-height: 1.8;\">\n                                            {{ $json.addons_html }}\n                                        </ul>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                            <!-- Consideraciones Especiales (HTML pre-generado) -->\n                            {{ $json.consideraciones_html }}\n                            \n                            <!-- Pr√≥ximos Pasos -->\n                            <h3 style=\"margin: 30px 0 15px 0; color: #333333; font-size: 18px; font-weight: 600; border-bottom: 2px solid #D4AF37; padding-bottom: 10px;\">\n                                üöÄ Pr√≥ximos Pasos\n                            </h3>\n                            \n                            <!-- Pr√≥ximos Pasos (HTML pre-generado) -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 30px;\">\n                                {{ $json.proximos_pasos_html }}\n                            </table>\n                            \n                            <!-- Despedida del AI -->\n                            <p style=\"margin: 0 0 30px 0; color: #555555; font-size: 15px; line-height: 1.7;\">\n                                {{ $json.despedida }}\n                            </p>\n                            \n                            <!-- Contact Info -->\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; padding: 20px; margin-bottom: 20px;\">\n                                <tr>\n                                    <td>\n                                        <p style=\"margin: 0 0 10px 0; color: #333333; font-size: 14px; font-weight: 600;\">\n                                            üìû ¬øTienes dudas urgentes?\n                                        </p>\n                                        <p style=\"margin: 0; color: #666666; font-size: 13px; line-height: 1.6;\">\n                                            <strong>WhatsApp:</strong> <a href=\"https://wa.me/584243855099\" style=\"color: #25D366; text-decoration: none;\">+58 424 385 5099</a><br>\n                                            <strong>Email:</strong> <a href=\"mailto:contacto@livemoments.com\" style=\"color: #D4AF37; text-decoration: none;\">contacto@livemoments.com</a><br>\n                                            <strong>Horario:</strong> Lun-Vie 9:00 AM - 6:00 PM\n                                        </p>\n                                    </td>\n                                </tr>\n                            </table>\n                            \n                        </td>\n                    </tr>\n                    \n                    <!-- Footer -->\n                    <tr>\n                        <td style=\"background-color: #2c3e50; padding: 30px 40px; text-align: center;\">\n                            <p style=\"margin: 0 0 10px 0; color: #ffffff; font-size: 16px; font-weight: 600;\">\n                                Live Moments\n                            </p>\n                            <p style=\"margin: 0 0 15px 0; color: #bdc3c7; font-size: 13px;\">\n                                Streaming Profesional que Conecta Audiencias\n                            </p>\n                            <p style=\"margin: 15px 0 0 0; color: #95a5a6; font-size: 11px;\">\n                                ¬© 2024 Live Moments. Todos los derechos reservados.\n                            </p>\n                        </td>\n                    </tr>\n                    \n                </table>\n            </td>\n        </tr>\n    </table>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1152,
        -112
      ],
      "id": "ee65ba3c-283b-49e7-ac7c-7ecb894eb9f8",
      "name": "correoConfirmacionCliente",
      "webhookId": "46194ad1-dddb-4451-be70-2279930b83d9",
      "credentials": {
        "gmailOAuth2": {
          "id": "DtUkw6u9qFGHi6uQ",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1eXo8RTxnayKD7RbDxfUjnmzpvlQLwK3QDX5aKvKC4fo",
          "mode": "list",
          "cachedResultName": "Registra solicitud exitosa",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1eXo8RTxnayKD7RbDxfUjnmzpvlQLwK3QDX5aKvKC4fo/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1eXo8RTxnayKD7RbDxfUjnmzpvlQLwK3QDX5aKvKC4fo/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $('calcularDias').item.json.timestamp_solicitud }}",
            "Nombre Cliente": "={{ $('formularioValido').item.json.nombre_cliente }}",
            "Email": "={{ $('formularioValido').item.json.email_cliente }}",
            "Tel√©fono": "={{ $('formularioValido').item.json.telefono_cliente }}",
            "Tipo Evento": "={{ $('formularioValido').item.json.tipo_evento }}",
            "Fecha Evento": "={{ $('formularioValido').item.json.fecha_evento }}",
            "Ubicaci√≥n": "={{ $('formularioValido').item.json.ubicacion_evento }}",
            "Paquete": "={{ $('formularioValido').item.json.paquete_interes }}",
            "Add-ons": "={{ $('formularioValido').item.json.add_ons_solicitados }}",
            "id": "={{ $json.id }}",
            "Tono Correo": "={{ $('procesarRespuesta').item.json.tono_detectado }}",
            "Urgencia": "={{ $('formularioValido').item.json.nivel_urgencia }}",
            "Estado": "En proceso",
            "threadId": "={{ $json.threadId }}",
            "labelIds": "={{ $json.labelIds[0] }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nombre Cliente",
              "displayName": "Nombre Cliente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tel√©fono",
              "displayName": "Tel√©fono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tipo Evento",
              "displayName": "Tipo Evento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Fecha Evento",
              "displayName": "Fecha Evento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Ubicaci√≥n",
              "displayName": "Ubicaci√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Paquete",
              "displayName": "Paquete",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Add-ons",
              "displayName": "Add-ons",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Tono Correo",
              "displayName": "Tono Correo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Urgencia",
              "displayName": "Urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Estado",
              "displayName": "Estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "threadId",
              "displayName": "threadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "labelIds",
              "displayName": "labelIds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1376,
        -112
      ],
      "id": "a857732e-e277-411d-bdd4-050232456822",
      "name": "resgitroExitoso",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "pn9KPrV0bTFz3NPp",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"¬°Gracias! Tu solicitud ha sido recibida exitosamente. Revisa tu correo para m√°s detalles.\",\n  \"codigo\": \"SOLICITUD_EXITOSA\",\n  \"datos\": {\n    \"nombre\": \"={{ $('formularioValido').item.json.nombre_cliente }}\",\n    \"email\": \"={{ $('formularioValido').item.json.email_cliente }}\",\n    \"tipo_evento\": \"={{ $('formularioValido').item.json.tipo_evento}}\"\n  }\n}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1824,
        -112
      ],
      "id": "f4dbd2f8-d3ee-4b49-aad7-f90cb870903b",
      "name": "responderCode200"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3a36eb41-fa22-49e2-9952-8e1a5d851682",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        704,
        -16
      ],
      "id": "7937bff2-9336-4c1b-a527-8ed7436bbdb0",
      "name": "setEmailGen√©rico"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// Template de email gen√©rico (sin personalizaci√≥n de IA)\nconst asuntoGenerico = `‚úÖ Confirmaci√≥n de Solicitud - Live Moments`;\n\nconst cuerpoGenerico = `\n<!DOCTYPE html>\n<html>\n<head>\n    <style>\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n        .header { background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%); color: #1a1a1a; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n        .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }\n        .footer { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; }\n        .highlight { color: #D4AF37; font-weight: bold; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>¬°Solicitud Recibida!</h1>\n        </div>\n        <div class=\"content\">\n            <p>Hola <strong>${input.nombre_cliente}</strong>,</p>\n            \n            <p>Hemos recibido exitosamente tu solicitud para el evento <span class=\"highlight\">${input.tipo_evento}</span> programado para el <span class=\"highlight\">${new Date(input.fecha_evento).toLocaleDateString('es-ES')}</span>.</p>\n            \n            <p>Nuestro equipo de <strong>Live Moments Production</strong> revisar√° los detalles y se pondr√° en contacto contigo en las pr√≥ximas 24 horas para confirmar disponibilidad y coordinar los siguientes pasos.</p>\n            \n            <p><strong>Resumen de tu solicitud:</strong></p>\n            <ul>\n                <li>üìÖ Fecha: ${new Date(input.fecha_evento).toLocaleDateString('es-ES')}</li>\n                <li>üìç Ubicaci√≥n: ${input.ubicacion_evento}</li>\n                <li>üì¶ Paquete: ${input.paquete_interes}</li>\n                <li>‚è±Ô∏è Duraci√≥n: ${input.duracion_estimada}</li>\n            </ul>\n            \n            <p>Si tienes alguna pregunta urgente, no dudes en contactarnos.</p>\n            \n            <p>¬°Gracias por confiar en nosotros para conservar tus mejores momentos!</p>\n        </div>\n        <div class=\"footer\">\n            <p>Live Moments Production | Streaming Profesional</p>\n            <p>Este es un correo autom√°tico, por favor no respondas a este mensaje.</p>\n        </div>\n    </div>\n</body>\n</html>\n`;\n\nreturn {\n    ...input,\n    asunto_correo: asuntoGenerico,\n    cuerpo_correo: cuerpoGenerico,\n    tipo_email: \"generico_fallback\"\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        -16
      ],
      "id": "864c6817-a1e3-4391-97b8-267daf1911a1",
      "name": "procesarEmailGenerico"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6b693c44-67f5-47cf-9f60-c6a25e9f9910",
              "leftValue": "={{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        480,
        -112
      ],
      "id": "f1c3464c-cd6e-4701-830b-16d091595725",
      "name": "¬øIA Exitosa?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "082651d2-f398-4cd4-8bae-3ff1a7835f39",
              "name": "webhook_url",
              "value": "https://machinery-efficiently-sofa-directory.trycloudflare.com",
              "type": "string"
            },
            {
              "id": "a364ba3d-25cb-4f41-9808-334b62d331c3",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1216,
        624
      ],
      "id": "dfa809d0-2b50-44d7-917d-778a3be0b0d1",
      "name": "Configuracion"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        144,
        128
      ],
      "id": "bba0b8ed-fd7e-443e-95d4-b4fd59763de7",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "ZrCFnMmAvzAfyUkm",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"asunto\": \"Asunto del correo\",\n  \"saludo\": \"Saludo personalizado\",\n  \"parrafo_confirmacion\": \"Confirmaci√≥n de recepci√≥n\",\n  \"recomendaciones\": {\n    \"paquete\": \"Recomendaci√≥n sobre paquete o null\",\n    \"addons\": [\"addon1\", \"addon2\"],\n    \"consideraciones\": \"Consideraciones especiales o null\"\n  },\n  \"proximos_pasos\": [\"paso1\", \"paso2\", \"paso3\"],\n  \"despedida\": \"Despedida personalizada\",\n  \"tono_detectado\": \"formal|entusiasta|amigable\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        272,
        128
      ],
      "id": "e04ba81e-619c-43da-8bda-c85384841954",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "chatId": "-1003434099916",
        "text": "=üö® **NUEVA SOLICITUD**  \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë§ **DATOS DEL CLIENTE** \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìõ Nombre: {{ $('formularioValido').item.json.nombre_cliente }} \nüìß Email: {{ $('formularioValido').item.json.email_cliente }} \nüìû Tel√©fono: {{ $('formularioValido').item.json.telefono_cliente }}  \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ \nüé¨ **DETALLES DEL EVENTO** \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  \nTipo: {{ $('formularioValido').item.json.tipo_evento }} \nüìÖ Fecha: {{ $('formularioValido').item.json.fecha_evento }} \nüìç Ubicaci√≥n: {{ $('formularioValido').item.json.ubicacion_evento }} \n‚è±Ô∏è Duraci√≥n: {{ $('formularioValido').item.json.duracion_estimada }}  \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ \nüíº **PAQUETE Y URGENCIA** \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  \nüì¶ Paquete: {{ $('formularioValido').item.json.paquete_interes }} {{ $('formularioValido').item.json.emoji_urgencia }} \nUrgencia: {{ $('formularioValido').item.json.nivel_urgencia }} \nüìÜ D√≠as restantes: {{ $('formularioValido').item.json.dias_del_evento }}  \n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  \n‚úÖ **ACCI√ìN REQUERIDA:** \nContactar al cliente en las pr√≥ximas 24 horas",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1600,
        -112
      ],
      "id": "06bd0486-5c35-4725-a2d3-3d9e65aa8846",
      "name": "enviarExitosoTelegram",
      "webhookId": "d17c9475-ed46-443b-bfdd-f8628461c6fb",
      "credentials": {
        "telegramApi": {
          "id": "pwBAa59uy9ggvhua",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "1d13cd10-3cb6-47ac-94ee-4e71e854fe9a",
      "name": "telegramTrigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        -3808,
        192
      ],
      "webhookId": "telegram-webhook-id",
      "credentials": {
        "telegramApi": {
          "id": "pwBAa59uy9ggvhua",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA",
          "mode": "list",
          "cachedResultName": "Sesiones_Telegram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{ $('telegramTrigger').item.json.message?.chat?.id || $('telegramTrigger').item.json.callback_query?.message?.chat?.id }}"
            }
          ]
        },
        "combineFilters": "=OR",
        "options": {}
      },
      "id": "cb549c70-1052-4e20-a939-585775f61ada",
      "name": "buscarSesion",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -3584,
        192
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "pn9KPrV0bTFz3NPp",
          "name": "Google Sheets account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: logicaBot (State Machine)\n * ============================================\n * \n * PROP√ìSITO:\n * Gestionar el flujo de la conversaci√≥n del bot de reservaciones.\n * Determina el siguiente paso basado en el estado actual y la entrada del usuario.\n * \n * INPUT (desde nodos anteriores):\n * - message: Objeto del mensaje de Telegram (texto, callback_query, etc.)\n * - session: Estado actual del usuario desde Google Sheets (paso_actual, datos_json)\n * \n * OUTPUT:\n * - response_text: Texto a enviar al usuario\n * - response_buttons: Botones inline (si aplica)\n * - next_step: Nuevo paso a guardar en Sheets\n * - update_data: Nuevos datos a guardar en Sheets\n * - action: Acci√≥n a ejecutar (ej: 'reply', 'send_to_central', 'cancel')\n */\n\n// ============================================\n// CONFIGURACI√ìN\n// ============================================\n\nconst STEPS = {\n  START: 'start',\n  TIPO_EVENTO: 'tipo_evento',\n  FECHA: 'fecha',\n  CIUDAD: 'ciudad',\n  PAQUETE: 'paquete',\n  NOMBRE: 'nombre',\n  EMAIL: 'email',\n  TELEFONO: 'telefono',\n  CONFIRMACION: 'confirmacion',\n  MENU_CORRECCION: 'menu_correccion',      // Nuevo: men√∫ para elegir qu√© corregir\n  CORRIGIENDO_CAMPO: 'corrigiendo_campo',  // Nuevo: capturando nuevo valor\n  VALIDACION_IA: 'validacion_ia',\n  COMPLETADO: 'completado'\n};\n\n// Configuraci√≥n del AI Validator\nconst AI_CONFIG = {\n  MAX_INTENTOS: 4,\n  ORIGEN: 'telegram',  // Identificador del canal\n  CAMPOS_REQUERIDOS: [\n    'tipo_evento',\n    'fecha_evento',\n    'ubicacion_evento',\n    'paquete_interes',\n    'nombre_cliente',\n    'email_cliente',\n    'telefono_cliente'\n  ]\n};\n\nconst OPTIONS = {\n  TIPO_EVENTO: [\n    [{ text: 'üéä Eventos Sociales', callback_data: 'Eventos sociales' }],\n    [{ text: 'üè¢ Corporativo', callback_data: 'Conferencias y eventos corporativos' }],\n    [{ text: 'üéÆ E-Sports', callback_data: 'E-Sport y Gaming' }],\n    [{ text: 'üéµ Conciertos', callback_data: 'Conciertos y Eventos Art√≠sticos' }],\n    [{ text: '‚õ™ Religiosos', callback_data: 'Eventos Religiosos' }],\n    [{ text: '‚öΩ Deportivos', callback_data: 'Eventos Deportivos' }]\n  ],\n  PAQUETE: [\n    [{ text: 'ü•â B√°sico (1 Cam)', callback_data: 'B√°sico' }],\n    [{ text: 'ü•à Est√°ndar (2 Cam)', callback_data: 'Est√°ndar' }],\n    [{ text: 'ü•á Premium (3 Cam)', callback_data: 'Premium' }],\n    [{ text: 'üíé Enterprise (4K)', callback_data: 'Enterprise' }]\n  ],\n  CONFIRMACION: [\n    [{ text: '‚úÖ Confirmar y Enviar', callback_data: 'confirmar' }],\n    [{ text: '‚úèÔ∏è Corregir un dato', callback_data: 'corregir' }],\n    [{ text: '‚ùå Cancelar', callback_data: 'cancelar' }]\n  ],\n  MENU_CORRECCION: [\n    [{ text: 'üéä Tipo de Evento', callback_data: 'edit_tipo_evento' }],\n    [{ text: 'üìÖ Fecha', callback_data: 'edit_fecha_evento' }],\n    [{ text: 'üìç Ciudad', callback_data: 'edit_ubicacion_evento' }],\n    [{ text: 'üì¶ Paquete', callback_data: 'edit_paquete_interes' }],\n    [{ text: 'üë§ Nombre', callback_data: 'edit_nombre_cliente' }],\n    [{ text: 'üìß Email', callback_data: 'edit_email_cliente' }],\n    [{ text: 'üìû Tel√©fono', callback_data: 'edit_telefono_cliente' }],\n    [{ text: '‚¨ÖÔ∏è Volver al Resumen', callback_data: 'volver_resumen' }]\n  ]\n};\n\n// ============================================\n// VALIDADORES\n// ============================================\n\nconst Validators = {\n  fecha: (text) => {\n    // Regex DD/MM/YYYY\n    const regex = /^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/;\n    const match = text.match(regex);\n    if (!match) return { valid: false, error: 'Formato incorrecto. Usa DD/MM/YYYY (ej: 25/12/2025)' };\n    \n    const day = parseInt(match[1]);\n    const month = parseInt(match[2]) - 1; // Meses 0-11\n    const year = parseInt(match[3]);\n    \n    const date = new Date(year, month, day);\n    const now = new Date();\n    now.setHours(0,0,0,0);\n    \n    if (date < now) return { valid: false, error: 'La fecha debe ser futura.' };\n    \n    return { valid: true, value: text };\n  },\n  \n  ciudad: (text) => {\n    if (!text || text.length < 3) return { valid: false, error: 'Por favor escribe una ciudad v√°lida (m√≠nimo 3 letras).' };\n    \n    // Detectar caracteres sospechosos (posible inyecci√≥n de comandos)\n    // Permitir: letras, n√∫meros, espacios, comas, acentos, √±, guiones simples entre palabras\n    const caracteresInvalidos = /[\\.\\/\\+\\&\\%\\@\\#\\$\\!\\?\\*\\<\\>\\|\\\\\\^\\[\\]\\{\\}\\(\\)\\`\\~\\_\\=]/;\n    if (caracteresInvalidos.test(text)) {\n      return { valid: false, error: 'La ciudad contiene caracteres no v√°lidos. Solo letras, espacios y comas.' };\n    }\n    \n    // Rechazar si empieza con / (comando de bot)\n    if (text.startsWith('/')) {\n      return { valid: false, error: 'Eso parece un comando, no una ciudad. Por favor escribe el nombre de la ciudad.' };\n    }\n    \n    return { valid: true, value: text };\n  },\n  \n  nombre: (text) => {\n    if (!text || text.length < 3) return { valid: false, error: 'Por favor escribe tu nombre completo.' };\n    return { valid: true, value: text };\n  },\n  \n  email: (text) => {\n    const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!regex.test(text)) return { valid: false, error: 'Correo inv√°lido. Ejemplo: nombre@correo.com' };\n    return { valid: true, value: text };\n  },\n  \n  telefono: (text) => {\n    // Acepta +, espacios, guiones y n√∫meros. M√≠nimo 10 d√≠gitos.\n    const clean = text.replace(/\\D/g, '');\n    if (clean.length < 10) return { valid: false, error: 'N√∫mero inv√°lido. Incluye c√≥digo de √°rea (ej: +58 412...)' };\n    return { valid: true, value: text };\n  }\n};\n\n// ============================================\n// L√ìGICA PRINCIPAL\n// ============================================\n\n// ============================================\n// MAPEO DE INPUTS (N8N)\n// ============================================\n\n// 1. Obtener el update de Telegram (siempre del nodo Trigger)\nlet telegramUpdate = {};\ntry {\n    telegramUpdate = $('telegramTrigger').first().json;\n} catch (e) {\n    console.log('‚ö†Ô∏è No se pudo leer telegramTrigger, usando input directo');\n    telegramUpdate = $input.item.json;\n}\n\n// 2. Obtener la sesi√≥n (del nodo buscarSesion)\nlet sessionData = {};\ntry {\n    // Intentamos leer del nodo buscarSesion si existe\n    sessionData = $('buscarSesion').first().json;\n} catch (e) {\n    console.log('‚ö†Ô∏è No se pudo leer buscarSesion, asumiendo sesi√≥n nueva');\n    sessionData = {};\n}\n\n// 3. Combinar todo en un objeto de trabajo\nconst update = {\n    ...telegramUpdate,\n    ...sessionData\n};\n\n// 4. Extraer datos espec√≠ficos\nconst session = {\n    paso_actual: sessionData.paso_actual || null,\n    datos_json: sessionData.datos_json || null,\n    intentos_fallidos: sessionData.intentos_fallidos || 0\n};\n\nconst incomingText = telegramUpdate.message?.text || '';\nconst incomingCallback = telegramUpdate.callback_query?.data || null;\n\n// Debugging\nconsole.log('--- DEBUG INFO ---');\nconsole.log('Telegram Update:', telegramUpdate);\nconsole.log('Session Data:', sessionData);\nconsole.log('Incoming Callback:', incomingCallback);\nconsole.log('Current Step:', session.paso_actual);\nconsole.log('------------------');\n\nlet currentStep = session.paso_actual || STEPS.START;\nconst currentData = session.datos_json ? JSON.parse(session.datos_json) : {};\nconst intentos = parseInt(session.intentos_fallidos || 0);\n\n// FALLBACK: Si estamos en START pero recibimos un callback, asumimos que es respuesta al men√∫\n// Esto corrige el problema si la sesi√≥n no se guard√≥/recuper√≥ correctamente\nif (currentStep === STEPS.START && incomingCallback) {\n    console.log('‚ö†Ô∏è Detectado callback en paso START. Forzando paso FECHA (Recovery Mode).');\n    currentStep = STEPS.FECHA;\n}\n\nlet response = {\n  text: '',\n  buttons: null, // Array de botones para N8N\n  next_step: currentStep,\n  update_data: currentData,\n  action: 'reply',\n  new_intentos: 0, // Por defecto reseteamos intentos si hay √©xito\n  tipoValidacion: 'BOT' // Por defecto, el bot controla la validaci√≥n\n};\n\n// Funci√≥n helper para generar mensaje de resumen seg√∫n el paso actual\nfunction generarMensajeResumen(paso, datos) {\n  const resumenDatos = [];\n  if (datos.tipo_evento) resumenDatos.push(`üéä Evento: ${datos.tipo_evento}`);\n  if (datos.fecha_evento) resumenDatos.push(`üìÖ Fecha: ${datos.fecha_evento}`);\n  if (datos.ubicacion_evento) resumenDatos.push(`üìç Ciudad: ${datos.ubicacion_evento}`);\n  if (datos.paquete_interes) resumenDatos.push(`üì¶ Paquete: ${datos.paquete_interes}`);\n  if (datos.nombre_cliente) resumenDatos.push(`üë§ Nombre: ${datos.nombre_cliente}`);\n  if (datos.email_cliente) resumenDatos.push(`üìß Email: ${datos.email_cliente}`);\n  \n  const datosStr = resumenDatos.length > 0 ? `**Datos guardados:**\\n${resumenDatos.join('\\n')}\\n\\n` : '';\n  \n  const mensajesPorPaso = {\n    [STEPS.FECHA]: '¬øQu√© tipo de evento deseas transmitir?',\n    [STEPS.CIUDAD]: 'üìÖ ¬øCu√°l es la fecha del evento? (DD/MM/YYYY)',\n    [STEPS.PAQUETE]: 'üìç ¬øEn qu√© ciudad ser√° el evento?',\n    [STEPS.NOMBRE]: 'üì¶ Selecciona un paquete:',\n    [STEPS.EMAIL]: 'üë§ ¬øCu√°l es tu nombre completo?',\n    [STEPS.TELEFONO]: 'üìß ¬øCu√°l es tu correo electr√≥nico?',\n    [STEPS.CONFIRMACION]: 'üìû ¬øCu√°l es tu n√∫mero de tel√©fono?',\n    [STEPS.COMPLETADO]: '¬øConfirmas los datos?'\n  };\n  \n  return datosStr + (mensajesPorPaso[paso] || 'Continuemos donde quedamos...');\n}\n\n// Funci√≥n helper para obtener botones seg√∫n el paso\nfunction obtenerBotonesParaPaso(paso) {\n  const botonesPorPaso = {\n    [STEPS.FECHA]: OPTIONS.TIPO_EVENTO,\n    [STEPS.NOMBRE]: OPTIONS.PAQUETE,\n    [STEPS.COMPLETADO]: OPTIONS.CONFIRMACION\n  };\n  return botonesPorPaso[paso] || null;\n}\n\n// Funci√≥n helper para generar el resumen completo de confirmaci√≥n\nfunction generarResumenConfirmacion(datos) {\n  const advertencia = datos.revision_manual ? '\\n‚ö†Ô∏è **Nota:** Algunos datos requieren revisi√≥n manual.\\n' : '';\n  \n  return `\nüìã **RESUMEN DE SOLICITUD**\n${advertencia}\nüë§ **Cliente:** ${datos.nombre_cliente || 'No especificado'}\nüìß **Email:** ${datos.email_cliente || 'No especificado'}\nüìû **Tel:** ${datos.telefono_cliente || 'No especificado'}\n\nüéä **Evento:** ${datos.tipo_evento || 'No especificado'}\nüìÖ **Fecha:** ${datos.fecha_evento || 'No especificado'}\nüìç **Lugar:** ${datos.ubicacion_evento || 'No especificado'}\nüì¶ **Paquete:** ${datos.paquete_interes || 'No especificado'}\n\n¬øTodo correcto?\n  `.trim();\n}\n\n// Funci√≥n helper para manejar validaci√≥n con fallback\n// fieldName: nombre del campo donde guardar el dato (ej: 'fecha_evento', 'nombre_cliente')\nfunction handleValidation(validatorResult, rawText, successNextStep, successMessage, fieldName) {\n  if (validatorResult.valid) {\n    // √âxito: Guardamos dato limpio y avanzamos\n    response.update_data[fieldName] = validatorResult.value;\n    \n    response.text = successMessage;\n    response.next_step = successNextStep;\n    response.new_intentos = 0;\n    return true;\n  } else {\n    // Error\n    if (intentos >= 1) {\n      // FALLBACK: Segundo error, aceptamos el dato tal cual\n      response.update_data[fieldName] = rawText;\n      response.update_data.revision_manual = true; // Flag para ventas\n      response.update_data[`error_${fieldName}`] = validatorResult.error;\n      \n      response.text = `‚ö†Ô∏è No pude validar este dato, pero lo anot√© tal cual para que un humano lo revise.\\n\\nContinuemos... ${successMessage}`;\n      response.next_step = successNextStep;\n      response.new_intentos = 0;\n      return true;\n    } else {\n      // Primer error: Pedimos intentar de nuevo\n      response.text = `‚ùå ${validatorResult.error}\\n\\nPor favor intenta de nuevo.`;\n      response.new_intentos = intentos + 1;\n      return false;\n    }\n  }\n}\n\n// Manejo de Comandos Globales\nif (incomingText === '/cancelar') {\n  return {\n    text: 'üö´ Reservaci√≥n cancelada. Escribe /reservar para comenzar de nuevo.',\n    action: 'cancel_session'\n  };\n}\n\nif (incomingText === '/start' || incomingText === '/reservar') {\n  // Verificar si ya existe una sesi√≥n activa con datos\n  const tieneSessionActiva = currentStep !== STEPS.START && Object.keys(currentData).length > 0;\n  \n  if (tieneSessionActiva) {\n    // Ya tiene sesi√≥n: NO reiniciar, continuar donde qued√≥\n    // Incrementar intentos fallidos (el usuario escribi√≥ /start en lugar del dato esperado)\n    const mensajeResumen = generarMensajeResumen(currentStep, currentData);\n    \n    return {\n      text: `üëã ¬°Hola de nuevo! Veo que ya ten√≠as una reservaci√≥n en progreso.\\n\\n${mensajeResumen}`,\n      buttons: obtenerBotonesParaPaso(currentStep),\n      next_step: currentStep,  // Mantener el paso actual\n      update_data: currentData,  // Preservar datos existentes\n      action: 'reply',\n      new_intentos: intentos + 1  // Incrementar intentos\n    };\n  }\n  \n  // No tiene sesi√≥n activa: comenzar nuevo flujo\n  return {\n    text: 'üëã ¬°Hola! Soy el asistente de Live Moments.\\n\\n¬øQu√© tipo de evento deseas transmitir?',\n    buttons: OPTIONS.TIPO_EVENTO,\n    next_step: STEPS.FECHA,\n    action: 'reply',\n    new_intentos: 0\n  };\n}\n\n// M√°quina de Estados\nswitch (currentStep) {\n  \n  case STEPS.START:\n    response.text = 'üëã ¬°Hola! Para comenzar una reservaci√≥n, elige una opci√≥n:';\n    response.buttons = OPTIONS.TIPO_EVENTO;\n    response.next_step = STEPS.FECHA;\n    break;\n\n  case STEPS.FECHA:\n    // Input anterior: TIPO_EVENTO\n    if (incomingCallback) {\n      response.update_data.tipo_evento = incomingCallback;\n      response.text = `‚úÖ Evento: ${incomingCallback}\\n\\nüìÖ ¬øCu√°l es la fecha del evento? (DD/MM/YYYY)`;\n      response.next_step = STEPS.CIUDAD;\n    } else {\n      // Si escribi√≥ texto, asumimos que es el tipo (fallback simple)\n      response.update_data.tipo_evento = incomingText;\n      response.text = `üìÖ ¬øCu√°l es la fecha del evento? (DD/MM/YYYY)`;\n      response.next_step = STEPS.CIUDAD;\n    }\n    break;\n\n  case STEPS.CIUDAD:\n    // Input anterior: FECHA\n    handleValidation(\n      Validators.fecha(incomingText), \n      incomingText, \n      STEPS.PAQUETE, \n      'üìç ¬øEn qu√© ciudad ser√° el evento?',\n      'fecha_evento'  // <-- Campo donde guardar\n    );\n    break;\n\n  case STEPS.PAQUETE:\n    // Input anterior: CIUDAD\n    handleValidation(\n      Validators.ciudad(incomingText),\n      incomingText,\n      STEPS.NOMBRE,\n      'üì¶ Selecciona un paquete:',\n      'ubicacion_evento'  // <-- Campo donde guardar\n    );\n    if (response.next_step === STEPS.NOMBRE) {\n        response.buttons = OPTIONS.PAQUETE;\n    }\n    break;\n\n  case STEPS.NOMBRE:\n    // Input anterior: PAQUETE (Callback)\n    if (incomingCallback) {\n      response.update_data.paquete_interes = incomingCallback;\n      response.text = `‚úÖ Paquete: ${incomingCallback}\\n\\nüë§ ¬øCu√°l es tu nombre completo?`;\n      response.next_step = STEPS.EMAIL;\n    } else {\n      response.text = '‚ö†Ô∏è Por favor selecciona un paquete usando los botones.';\n      response.buttons = OPTIONS.PAQUETE;\n    }\n    break;\n\n  case STEPS.EMAIL:\n    // Input anterior: NOMBRE\n    handleValidation(\n      Validators.nombre(incomingText),\n      incomingText,\n      STEPS.TELEFONO,\n      'üìß ¬øCu√°l es tu correo electr√≥nico?',\n      'nombre_cliente'  // <-- Campo donde guardar\n    );\n    break;\n\n  case STEPS.TELEFONO:\n    // Input anterior: EMAIL\n    handleValidation(\n      Validators.email(incomingText),\n      incomingText,\n      STEPS.CONFIRMACION,\n      'üìû ¬øCu√°l es tu n√∫mero de tel√©fono?',\n      'email_cliente'  // <-- Campo donde guardar\n    );\n    break;\n\n  case STEPS.CONFIRMACION:\n    // Input anterior: TELEFONO\n    const validado = handleValidation(\n      Validators.telefono(incomingText),\n      incomingText,\n      STEPS.COMPLETADO,\n      '', // El mensaje se genera abajo\n      'telefono_cliente'  // <-- Campo donde guardar\n    );\n    \n    if (validado) {\n      const d = response.update_data;\n      const advertencia = d.revision_manual ? '\\n‚ö†Ô∏è **Nota:** Algunos datos requieren revisi√≥n manual.\\n' : '';\n      \n      const resumen = `\nüìã **RESUMEN DE SOLICITUD**\n${advertencia}\nüë§ **Cliente:** ${d.nombre_cliente}\nüìß **Email:** ${d.email_cliente}\nüìû **Tel:** ${d.telefono_cliente}\n\nüéä **Evento:** ${d.tipo_evento}\nüìÖ **Fecha:** ${d.fecha_evento}\nüìç **Lugar:** ${d.ubicacion_evento}\nüì¶ **Paquete:** ${d.paquete_interes}\n\n¬øTodo correcto?\n      `;\n      response.text = resumen;\n      response.buttons = OPTIONS.CONFIRMACION;\n    }\n    break;\n\n  case STEPS.COMPLETADO:\n    if (incomingCallback === 'confirmar') {\n      // En lugar de enviar directo, pasamos a validaci√≥n IA\n      response.text = 'üîç Validando tus datos...';\n      response.action = 'validate_with_ai';  // Nueva acci√≥n\n      response.next_step = STEPS.VALIDACION_IA;\n      response.update_data.origen = AI_CONFIG.ORIGEN;  // Marcar origen\n      response.update_data.intentos_validacion = 0;     // Iniciar contador\n      response.update_data.tipoValidacion = 'IA';       // Marcar que la IA controla\n    } else if (incomingCallback === 'corregir') {\n      // Mostrar men√∫ de campos a corregir\n      response.text = '‚úèÔ∏è ¬øQu√© dato deseas corregir?';\n      response.buttons = OPTIONS.MENU_CORRECCION;\n      response.next_step = STEPS.MENU_CORRECCION;\n    } else if (incomingCallback === 'cancelar') {\n      response.text = 'üö´ Solicitud cancelada.';\n      response.action = 'cancel_session';\n    } else {\n      response.text = 'Por favor elige una opci√≥n usando los botones.';\n      response.buttons = OPTIONS.CONFIRMACION;\n    }\n    break;\n\n  case STEPS.MENU_CORRECCION:\n    // El usuario eligi√≥ qu√© campo corregir\n    if (incomingCallback === 'volver_resumen') {\n      // Volver al resumen sin cambios\n      const d = response.update_data;\n      const resumen = generarResumenConfirmacion(d);\n      response.text = resumen;\n      response.buttons = OPTIONS.CONFIRMACION;\n      response.next_step = STEPS.COMPLETADO;\n    } else if (incomingCallback && incomingCallback.startsWith('edit_')) {\n      // Extraer el nombre del campo a editar\n      const campoEditar = incomingCallback.replace('edit_', '');\n      response.update_data._campo_editando = campoEditar;\n      \n      // Mostrar mensaje seg√∫n el campo\n      const mensajesEdicion = {\n        'tipo_evento': 'üéä Selecciona el nuevo tipo de evento:',\n        'fecha_evento': 'üìÖ Escribe la nueva fecha (DD/MM/YYYY):',\n        'ubicacion_evento': 'üìç Escribe la nueva ciudad:',\n        'paquete_interes': 'üì¶ Selecciona el nuevo paquete:',\n        'nombre_cliente': 'üë§ Escribe tu nombre completo:',\n        'email_cliente': 'üìß Escribe tu correo electr√≥nico:',\n        'telefono_cliente': 'üìû Escribe tu n√∫mero de tel√©fono:'\n      };\n      \n      response.text = mensajesEdicion[campoEditar] || 'Escribe el nuevo valor:';\n      response.next_step = STEPS.CORRIGIENDO_CAMPO;\n      \n      // Si es tipo_evento o paquete, mostrar botones\n      if (campoEditar === 'tipo_evento') {\n        response.buttons = OPTIONS.TIPO_EVENTO;\n      } else if (campoEditar === 'paquete_interes') {\n        response.buttons = OPTIONS.PAQUETE;\n      }\n    } else {\n      response.text = '‚ö†Ô∏è Por favor selecciona una opci√≥n del men√∫.';\n      response.buttons = OPTIONS.MENU_CORRECCION;\n    }\n    break;\n\n  case STEPS.CORRIGIENDO_CAMPO:\n    // El usuario est√° ingresando el nuevo valor del campo\n    const campoEditando = currentData._campo_editando;\n    const nuevoValor = incomingCallback || incomingText;\n    \n    if (campoEditando && nuevoValor) {\n      // Validar el nuevo valor seg√∫n el campo\n      let valorValidado = nuevoValor;\n      let esValido = true;\n      \n      // Aplicar validador correspondiente\n      if (campoEditando === 'fecha_evento') {\n        const resultado = Validators.fecha(nuevoValor);\n        esValido = resultado.valid;\n        if (!esValido) {\n          response.text = `‚ùå ${resultado.error}\\n\\nIntenta de nuevo:`;\n          response.next_step = STEPS.CORRIGIENDO_CAMPO;\n          break;\n        }\n        valorValidado = resultado.value;\n      } else if (campoEditando === 'ubicacion_evento') {\n        const resultado = Validators.ciudad(nuevoValor);\n        esValido = resultado.valid;\n        if (!esValido) {\n          response.text = `‚ùå ${resultado.error}\\n\\nIntenta de nuevo:`;\n          response.next_step = STEPS.CORRIGIENDO_CAMPO;\n          break;\n        }\n        valorValidado = resultado.value;\n      } else if (campoEditando === 'nombre_cliente') {\n        const resultado = Validators.nombre(nuevoValor);\n        esValido = resultado.valid;\n        if (!esValido) {\n          response.text = `‚ùå ${resultado.error}\\n\\nIntenta de nuevo:`;\n          response.next_step = STEPS.CORRIGIENDO_CAMPO;\n          break;\n        }\n        valorValidado = resultado.value;\n      } else if (campoEditando === 'email_cliente') {\n        const resultado = Validators.email(nuevoValor);\n        esValido = resultado.valid;\n        if (!esValido) {\n          response.text = `‚ùå ${resultado.error}\\n\\nIntenta de nuevo:`;\n          response.next_step = STEPS.CORRIGIENDO_CAMPO;\n          break;\n        }\n        valorValidado = resultado.value;\n      } else if (campoEditando === 'telefono_cliente') {\n        const resultado = Validators.telefono(nuevoValor);\n        esValido = resultado.valid;\n        if (!esValido) {\n          response.text = `‚ùå ${resultado.error}\\n\\nIntenta de nuevo:`;\n          response.next_step = STEPS.CORRIGIENDO_CAMPO;\n          break;\n        }\n        valorValidado = resultado.value;\n      }\n      \n      // Guardar el nuevo valor\n      response.update_data[campoEditando] = valorValidado;\n      delete response.update_data._campo_editando;\n      \n      // Volver al resumen\n      const d = response.update_data;\n      const resumen = `‚úÖ **Dato actualizado**\\n\\n${generarResumenConfirmacion(d)}`;\n      response.text = resumen;\n      response.buttons = OPTIONS.CONFIRMACION;\n      response.next_step = STEPS.COMPLETADO;\n    } else {\n      response.text = '‚ö†Ô∏è No recib√≠ un valor v√°lido. Por favor intenta de nuevo.';\n      response.next_step = STEPS.CORRIGIENDO_CAMPO;\n    }\n    break;\n\n  case STEPS.VALIDACION_IA:\n    // Este paso maneja respuestas a preguntas de la IA sobre campos faltantes\n    const campoFaltante = currentData._campo_pendiente;\n    const intentosIA = parseInt(currentData.intentos_validacion || 0);\n    \n    if (campoFaltante && incomingText) {\n      // Guardamos la respuesta en el campo correspondiente\n      response.update_data[campoFaltante] = incomingText;\n      delete response.update_data._campo_pendiente;\n      \n      // Incrementar contador de intentos\n      response.update_data.intentos_validacion = intentosIA + 1;\n      \n      // Verificar l√≠mite de intentos\n      if (intentosIA + 1 >= AI_CONFIG.MAX_INTENTOS) {\n        response.text = '‚ö†Ô∏è Se alcanz√≥ el l√≠mite de validaciones. Tu solicitud ser√° revisada manualmente.';\n        response.action = 'send_to_error_support';  // Escalar a soporte\n        response.update_data.requiere_revision = true;\n        response.next_step = STEPS.START;\n      } else {\n        // Volver a validar con IA\n        response.text = 'üîç Verificando...';\n        response.action = 'validate_with_ai';\n        response.next_step = STEPS.VALIDACION_IA;\n      }\n    } else {\n      // No hay campo pendiente o no hay texto, continuar validaci√≥n\n      response.action = 'validate_with_ai';\n      response.next_step = STEPS.VALIDACION_IA;\n    }\n    break;\n\n  default:\n    response.text = '‚ö†Ô∏è Error de estado. Escribe /start para reiniciar.';\n    response.next_step = STEPS.START;\n}\n\n// Validaci√≥n de seguridad: nunca enviar texto vac√≠o\nif (!response.text || response.text.trim() === '') {\n  response.text = '‚ö†Ô∏è Ocurri√≥ un error. Por favor escribe /start para comenzar de nuevo.';\n}\n\nreturn response;\n"
      },
      "id": "1373a86e-8e51-492a-b714-8c9e22368d30",
      "name": "logicaBot",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2912,
        -80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ef278a3-d116-4d40-9327-c85debff0ba2",
              "leftValue": "={{ $json.isEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3360,
        192
      ],
      "id": "d01a6321-4bb3-458f-af09-c76738bb1569",
      "name": "esNuevoUsuario"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA",
          "mode": "list",
          "cachedResultName": "Sesiones_Telegram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $('telegramTrigger').item.json.message?.chat?.id || $('telegramTrigger').item.json.callback_query?.message?.chat?.id }}",
            "paso_actual": "={{ $('telegramTrigger').item.json.message.text }}",
            "intentos_fallidos": "0",
            "ultima_interaccion": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_json",
              "displayName": "datos_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intentos_fallidos",
              "displayName": "intentos_fallidos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "update_id",
              "displayName": "update_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "callback_query",
              "displayName": "callback_query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "57a1ce14-dcc3-42b2-b03c-cf25e65b2ce3",
      "name": "crearSesion",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -3136,
        -80
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "pn9KPrV0bTFz3NPp",
          "name": "Google Sheets account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -2400,
        176
      ],
      "id": "239e94a8-4fa5-46e9-936c-15689a2d280e",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "ZrCFnMmAvzAfyUkm",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "validate_with_ai",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8d729915-72f7-4aa3-a7af-112659c5c84e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "AI Agent"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "97bcbcbe-384b-4a80-8528-0028f2d541e0",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "send_to_central",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Workflow Central"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b2c5ec52-9ac3-4c76-bf0b-7b26bc4c46f1",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "cancel_session",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "750b6895-0193-4427-b01e-afaaec3c129e",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "HTTP Request Telegram"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5fc7e0f3-82e5-4969-bd3a-f12a02ede853",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "send_to_error_support",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Correo Error"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -2688,
        -80
      ],
      "id": "22f7e742-63ee-4b19-9610-f0297e074387",
      "name": "switchAccion"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64088e52-161e-4b54-b5da-035aebd33849",
              "leftValue": "={{ $json.tipoValidacion }}",
              "rightValue": "IA",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3136,
        528
      ],
      "id": "5d9bd0a2-4c02-49e3-8f18-1aa07875e95d",
      "name": "esValidacionIA"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: prepararDatosIA\n * ============================================\n * \n * PROP√ìSITO:\n * Preparar los datos cuando el usuario responde a una pregunta de la IA.\n * Este nodo se usa cuando tipoValidacion = 'IA' para bypass de logicaBot.\n * \n * INPUT:\n * - Session data desde buscarSesion (incluye datos_json con _campo_pendiente)\n * - Telegram message desde telegramTrigger\n * \n * OUTPUT:\n * - update_data: Datos completos con el campo corregido\n * - campo_pendiente: El campo que se est√° corrigiendo\n * - respuesta_usuario: El valor nuevo que el usuario proporcion√≥\n * - Para AI Agent: contexto completo para re-validar\n */\n\nconst session = $input.item.json;\nconst telegramData = $('telegramTrigger').first().json;\n\n// Obtener el texto o callback del usuario\nconst incomingText = telegramData.message?.text || '';\nconst incomingCallback = telegramData.callback_query?.data || '';\nconst userInput = incomingText || incomingCallback;\n\n// Obtener chat_id\nconst chatId = telegramData.message?.chat?.id || telegramData.callback_query?.message?.chat?.id;\n\n// Parsear datos existentes de la sesi√≥n\nlet datosUsuario = {};\ntry {\n  datosUsuario = JSON.parse(session.datos_json || '{}');\n  console.log('‚úÖ datos_json parseado correctamente:', JSON.stringify(datosUsuario));\n} catch (e) {\n  console.error('‚ùå Error parseando datos_json:', e);\n  console.log('Raw datos_json:', session.datos_json);\n  datosUsuario = {};\n}\n\n// Obtener el campo pendiente y los errores anteriores\nconst campoPendiente = datosUsuario._campo_pendiente || null;\nconst erroresAnteriores = datosUsuario._errores_ia || [];\nconst intentosActuales = parseInt(datosUsuario.intentos_validacion || 0);\n\nconsole.log(`üîç Campo pendiente: ${campoPendiente}`);\nconsole.log(`üìù Respuesta del usuario: ${userInput}`);\n\n// Si hay un campo pendiente y el usuario envi√≥ algo, actualizar\nif (campoPendiente && userInput) {\n  console.log(`‚úèÔ∏è Actualizando campo ${campoPendiente} con valor: ${userInput}`);\n  datosUsuario[campoPendiente] = userInput;\n}\n\n// Incrementar contador de intentos\ndatosUsuario.intentos_validacion = intentosActuales + 1;\n\n// Preparar contexto para el AI Agent\n// El AI Agent necesita saber: datos actuales, qu√© campo se corrigi√≥, y el valor nuevo\nconst contextoIA = {\n  datos_actuales: datosUsuario,\n  campo_corregido: campoPendiente,\n  valor_nuevo: userInput,\n  intentos: datosUsuario.intentos_validacion,\n  errores_anteriores: erroresAnteriores\n};\n\nreturn {\n  // Datos principales para el AI Agent\n  update_data: datosUsuario,\n  \n  // Contexto adicional para el AI Agent's User Message\n  campo_pendiente: campoPendiente,\n  respuesta_usuario: userInput,\n  contexto_validacion: JSON.stringify(contextoIA),\n  \n  // Metadata\n  chat_id: chatId,\n  origen: datosUsuario.origen || 'telegram',\n  intentos_validacion: datosUsuario.intentos_validacion,\n  tipoValidacion: 'IA',\n  \n  // Debug\n  _debug: {\n    session_raw: session,\n    campo_pendiente: campoPendiente,\n    user_input: userInput,\n    datos_parseados: datosUsuario,\n    timestamp: new Date().toISOString()\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        512
      ],
      "id": "0064c437-fa7e-445d-b61e-76ad039c2569",
      "name": "prepararDatosIA"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1216,
        -80
      ],
      "id": "3eb837db-c66c-4e90-a8ba-9a46ce763023",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA",
          "mode": "list",
          "cachedResultName": "Sesiones_Telegram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1RpFKNcF80lQgmt3k4-YTU0UJg9Vwih1_Gsd8tD66yuA/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $('telegramTrigger').item.json.message?.chat?.id || $('telegramTrigger').item.json.callback_query?.message?.chat?.id }}",
            "paso_actual": "={{ $if($(' validadorIA').isExecuted, $(' validadorIA').item.json.next_step, $('switchAccion').item.json.next_step) }}",
            "datos_json": "={{ $if($(' validadorIA').isExecuted, JSON.stringify($(' validadorIA').item.json.update_data), JSON.stringify($('switchAccion').item.json.update_data)) }}",
            "ultima_interaccion": "={{ new Date().toISOString() }}",
            "intentos_fallidos": "={{ $if($(' validadorIA').isExecuted, $(' validadorIA').item.json.update_data?.intentos_validacion || 0, $('switchAccion').item.json.new_intentos || 0) }}",
            "tipoValidacion": "={{ $if($(' validadorIA').isExecuted, $(' validadorIA').item.json.update_data?.tipoValidacion || 'IA', $('switchAccion').item.json.tipoValidacion || 'BOT') }}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_json",
              "displayName": "datos_json",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intentos_fallidos",
              "displayName": "intentos_fallidos",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "update_id",
              "displayName": "update_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "message",
              "displayName": "message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "callback_query",
              "displayName": "callback_query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tipoValidacion",
              "displayName": "tipoValidacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f564c9d8-f7f1-435c-9fad-c10de049854f",
      "name": "actualizarSesion",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -1440,
        -544
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "pn9KPrV0bTFz3NPp",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: validarDatosIA\n * ============================================ \n * \n * PROP√ìSITO:\n * Validaci√≥n b√°sica de datos DESPU√âS de la validaci√≥n de IA.\n * Verifica formato de nombre, email y tel√©fono.\n * \n * INPUT: Viene de ValidadorIA, datos est√°n en update_data\n * OUTPUT: Agrega datos_validos y lista_errores\n */\n\nconst input = $input.item.json;\nconst errores = [];\n\n// Los datos vienen en update_data desde ValidadorIA\nconst datos = input.update_data || {};\n\nif (!datos.nombre_cliente || datos.nombre_cliente.length < 3) {\n    errores.push(\"Nombre inv√°lido\");\n}\nif (!datos.email_cliente || !datos.email_cliente.includes('@')) {\n    errores.push(\"Email inv√°lido\");\n}\nif (!datos.telefono_cliente || datos.telefono_cliente.replace(/\\D/g, '').length < 10) {\n    errores.push(\"Tel√©fono inv√°lido\");\n}\n\nreturn {\n    ...input,\n    datos_validos: errores.length === 0,\n    lista_errores: errores\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1888,
        -64
      ],
      "id": "148294ac-ce72-421b-9452-6c4adc6642cb",
      "name": "validarDatosIA"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "send_to_central",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "74df0a83-c9da-4bd7-a7fe-4024d6e33724"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "send_to_central"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6cacbeec-0ccf-491f-99c5-16622a822d86",
                    "leftValue": "={{$json.action}}",
                    "rightValue": "ask_field",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ask_field"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b30fb6c-802e-4852-b8fb-cdd6dbf308bf",
                    "leftValue": "={{$json.action}}",
                    "rightValue": "send_to_error_support",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "send_to_error_support"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1664,
        -80
      ],
      "id": "5317aeee-4403-49e1-86ad-25ba7f2c9765",
      "name": "switchValidacionIA"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8450594238:AAHSw3lVD_SKbHhJavglYKsd0WKptmsulV0/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n  (() => {\n    // Determinar de d√≥nde vienen los botones (si hay)\n    const buttons = $if(\n      $('switchAccion').isExecuted,\n      $('switchAccion').item.json.buttons,\n      null\n    );\n    \n    // Determinar el texto - puede venir de switchAccion O de ValidadorIA\n    const texto = $if(\n      $(' validadorIA').isExecuted,\n      $(' validadorIA').item.json.text,\n      $('switchAccion').item.json.text\n    );\n    \n    // Objeto base\n    const body = {\n      \"chat_id\": $('telegramTrigger').item.json.message?.chat?.id || $('telegramTrigger').item.json.callback_query?.message?.chat?.id,\n      \"text\": texto\n    };\n    // Solo agregar reply_markup si hay botones v√°lidos\n    if (buttons && Array.isArray(buttons) && buttons.length > 0) {\n      body.reply_markup = {\n        \"inline_keyboard\": buttons\n      };\n    }\n    return body;\n  })()\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1440,
        -352
      ],
      "id": "49a5d2d7-88db-4a5f-8934-92830b6c84e5",
      "name": "HTTP_Request"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "502d5d42-25d0-4016-ae92-661472df7432",
              "leftValue": "={{ $('validarDatos').item.json.datos_validos }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -96,
        -80
      ],
      "id": "34cdb93a-11b1-47e3-9c30-436f13326fa7",
      "name": "existenDatosValidos"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify($json.update_data) }}",
        "options": {
          "systemMessage": "=Eres un validador de datos para \"Live Moments\", un servicio de streaming profesional para eventos.\n\nTu tarea es validar que los datos de la solicitud est√©n completos y correctos.\n\nREGLAS DE VALIDACI√ìN:\n1. tipo_evento: No debe estar vac√≠o. Valores v√°lidos: \"Eventos sociales\", \"Conferencias y eventos corporativos\", \"E-Sport y Gaming\", \"Conciertos y Eventos Art√≠sticos\", \"Eventos Religiosos\", \"Eventos Deportivos\"\n2. fecha_evento: Formato DD/MM/YYYY o YYYY-MM-DD, debe ser fecha futura\n3. ubicacion_evento: M√≠nimo 3 caracteres, debe ser una ciudad o direcci√≥n real o ficticia, pero que este dentro de esos parametros, RECHAZAR si contiene: / + & % @ # $ ! ? * < > | \\ ^ [ ] { } ( ) ~ _ = (estos caracteres indican posible comando o inyecci√≥n)\n4. paquete_interes: Valores v√°lidos: \"B√°sico\", \"Est√°ndar\", \"Premium\", \"Enterprise\"\n5. nombre_cliente: M√≠nimo 3 caracteres, debe parecer un nombre real, RECHAZAR si contiene: / + & % @ # $ ! ? * < > | \\ ^ [ ] { } ( ) ~ _ = (estos caracteres indican posible comando o inyecci√≥n)\n6. email_cliente: Debe ser un email v√°lido (contener @ y dominio)\n7. telefono_cliente: Debe contener n√∫meros (al menos 7 d√≠gitos)\n\nINSTRUCCIONES:\n- El usuario puede cometer errores gramaticales, de puntuaci√≥n o acortar las palabras, eso NO hace inv√°lido el dato\n- Abreviaciones como \"Ccs\" (Caracas), \"Vzla\" (Venezuela) son V√ÅLIDAS\n- Si TODOS los campos est√°n presentes y v√°lidos, responde con valido: true\n- Si FALTA alg√∫n campo o es inv√°lido, identifica EL PRIMER campo con problema\n- Genera una pregunta AMIGABLE y DIRECTA para solicitar ese dato\n- S√© conversacional pero profesional\n\nRESPONDE √öNICAMENTE EN ESTE FORMATO JSON (sin markdown, sin explicaci√≥n):\n{\n  \"valido\": true/false,\n  \"campo_faltante\": \"nombre_del_campo\" o null si todo est√° bien,\n  \"pregunta_usuario\": \"Pregunta amigable para pedir el dato faltante\" o null,\n  \"errores\": [\"lista de problemas encontrados\"] o []\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -2464,
        -64
      ],
      "id": "d37dcbc9-83a7-4d0d-b9f7-f8ebdbfb8732",
      "name": "capaValidadorIA"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Genera un correo de confirmaci√≥n personalizado para este cliente:\nDATOS DEL CLIENTE:\n- Nombre: {{ $json.nombre_cliente }}\n- Email: {{ $json.email_cliente }}\n- Tel√©fono: {{ $json.telefono_cliente }}\nDATOS DEL EVENTO:\n- Tipo: {{ $json.tipo_evento }}\n- Fecha: {{ $json.fecha_evento }}\n- Ubicaci√≥n: {{ $json.ubicacion_evento }}\n- Duraci√≥n: {{ $json.duracion_estimada }}\n- Internet en venue: {{ $json.tiene_internet_venue }}\nSOLICITUD:\n- Paquete seleccionado: {{ $json.paquete_interes }}\n- Add-ons solicitados: {{ $json.add_ons_solicitados ? $json.add_ons_solicitados.join(', ') : 'Ninguno' }}\n- D√≠as hasta el evento: {{ $json.dias_del_evento }}\nINSTRUCCIONES:\n1. Usa el tono apropiado seg√∫n el tipo de evento\n2. Confirma la recepci√≥n de la solicitud mencionando tipo de evento y fecha\n3. Proporciona recomendaciones sobre:\n   a) Validaci√≥n o mejora del paquete seleccionado (si aplica)\n   b) Add-ons relevantes que NO hayan sido seleccionados\n   c) Consideraciones especiales:\n      - Si el evento es en menos de 15 d√≠as: mencionar urgencia\n      - Si no hay internet: recomendar soluci√≥n (Starlink)\n      - Si duraci√≥n >6 horas: sugerir equipo de respaldo\n4. Indica pr√≥ximos pasos:\n   - Contacto del asesor en 24-48 horas\n   - Env√≠o de cotizaci√≥n personalizada\n   - Videollamada de asesor√≠a (si evento complejo)\n5. Despedida acorde al tono\nDevuelve SOLO el JSON, sin texto adicional.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Eres un asistente de ventas experto en servicios de streaming profesional multic√°mara para eventos en vivo. Tu empresa se llama \"Live Moments\".\nTU ROL:\n- Generar correos de confirmaci√≥n personalizados para clientes\n- Adaptar el tono seg√∫n el tipo de evento\n- Proporcionar recomendaciones relevantes y √∫tiles\n- Ser profesional pero cercano\nTONOS QUE DEBES USAR:\n1. FORMAL (para Eventos Religiosos y Conferencias/Corporativos):\n   - Vocabulario: ceremonias, servicios, presentaciones, audiencia\n   - Saludo: \"Estimado/a [Nombre]\"\n   - Despedida: \"Quedamos atentos. Saludos cordiales,\"\n   - Evitar: emojis excesivos, jerga informal\n2. ENTUSIASTA (para E-Sport/Gaming y Eventos Deportivos):\n   - Vocabulario: acci√≥n, jugadas, competencia, fans, emoci√≥n\n   - Saludo: \"¬°Hola [Nombre]! üéÆ\" o \"¬°Hola [Nombre]! ‚öΩ\"\n   - Despedida: \"¬°Nos vemos en la transmisi√≥n! üî•\"\n   - Usar: emojis relacionados (üéÆ üèÜ ‚ö° üî• ‚öΩ üèÄ)\n3. AMIGABLE (para Eventos Sociales):\n   - Vocabulario: celebraci√≥n, momentos especiales, familia, amigos\n   - Saludo: \"Hola [Nombre], ¬°qu√© emoci√≥n! üíù\"\n   - Despedida: \"¬°Estamos ansiosos por ser parte de tu celebraci√≥n! ‚ú®\"\n   - Usar: emojis emotivos (üíù üéâ ‚ú® üåü)\nPAQUETES DISPONIBLES:\n- B√°sico: 1 c√°mara HD, 1 micr√≥fono, streaming a 1 plataforma\n- Est√°ndar: 2 c√°maras HD, 2 micr√≥fonos, overlays b√°sicos\n- Premium: 3 c√°maras HD, 3 micr√≥fonos profesionales, overlays avanzados, director t√©cnico\n- Enterprise: 4 c√°maras 4K, 4 micr√≥fonos, streaming a 3 plataformas, branding personalizado\nADD-ONS DISPONIBLES:\n- C√°maras y Micr√≥fonos adicionales\n- Internet Starlink (Garant√≠a de conectividad)\n- Overlays Personalizados (Branding)\n- Plataforma Adicional (Multi-streaming)\n- Grabaci√≥n (Archivo permanente)\nREGLAS IMPORTANTES:\n- NO inventes datos que no tienes\n- NO prometas precios espec√≠ficos\n- NO garantices disponibilidad sin confirmar\n- S√ç s√© honesto sobre limitaciones\n- S√ç proporciona valor en cada recomendaci√≥n\nFORMATO DE SALIDA:\nDebes devolver √öNICAMENTE un objeto JSON v√°lido con esta estructura exacta:\n{\n  \"asunto\": \"Asunto del correo\",\n  \"saludo\": \"Saludo personalizado\",\n  \"parrafo_confirmacion\": \"Confirmaci√≥n de recepci√≥n\",\n  \"recomendaciones\": {\n    \"paquete\": \"Recomendaci√≥n sobre paquete o null\",\n    \"addons\": [\"addon1\", \"addon2\"] o [],\n    \"consideraciones\": \"Consideraciones especiales o null\"\n  },\n  \"proximos_pasos\": [\"paso1\", \"paso2\", \"paso3\"],\n  \"despedida\": \"Despedida personalizada\",\n  \"tono_detectado\": \"formal|entusiasta|amigable\"\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        128,
        -112
      ],
      "id": "fc0c34f1-d591-4b42-bd44-d7b5205529dc",
      "name": "generadorCorreoIA",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: ValidadorIA\n * ============================================\n * \n * PROP√ìSITO:\n * Valida los datos recolectados usando Gemini AI.\n * Si falta alg√∫n dato, genera una pregunta directa para el usuario.\n * \n * INPUT:\n * - update_data: Datos del usuario desde la sesi√≥n de Telegram\n * \n * OUTPUT:\n * - valido: boolean\n * - campo_faltante: string | null\n * - pregunta_usuario: string | null\n * - action: 'send_to_central' | 'ask_field' | 'send_to_error_support'\n * \n * CONFIGURACI√ìN EN N8N:\n * 1. Agregar nodo \"Google Gemini Chat Model\"\n * 2. Usar este prompt en el nodo \"Basic LLM Chain\" o \"AI Agent\"\n */\n\n// ============================================\n// C√ìDIGO PARA EL NODO CODE (post-ValidadorIA)\n// ============================================\n\n// Este c√≥digo procesa la respuesta de Gemini y decide la acci√≥n\n\nconst input = $input.item.json;\nconst respuestaGemini = input.output || input.response || input.text || input;\n\n// Intentar leer datos de prepararDatosIA primero (bypass IA), luego de logicaBot (flujo normal)\nlet datosUsuario;\nlet fuenteDatos = 'unknown';\ntry {\n  datosUsuario = $('prepararDatosIA').first().json.update_data;\n  fuenteDatos = 'prepararDatosIA';\n} catch (e) {\n  try {\n    datosUsuario = $('logicaBot').first().json.update_data || {};\n    fuenteDatos = 'logicaBot';\n  } catch (e2) {\n    datosUsuario = {};\n    fuenteDatos = 'fallback';\n  }\n}\nconsole.log(`üìä Fuente de datos: ${fuenteDatos}`);\n\nconst origen = datosUsuario.origen || 'telegram';\n\n// ============================================\n// SANITIZACI√ìN PRE-VALIDACI√ìN\n// ============================================\n// Limpiar campos que contienen caracteres sospechosos (inyecci√≥n de comandos)\n// Si un campo tiene caracteres inv√°lidos, lo ponemos en null para que la IA lo detecte\n\nconst caracteresInvalidos = /[\\.\\/\\+\\&\\%\\@\\#\\$\\!\\?\\*\\<\\>\\|\\\\\\^\\[\\]\\{\\}\\(\\)\\`\\~\\_\\=]/;\n\n// Campos de texto que deben sanitizarse\nconst camposTexto = ['ubicacion_evento', 'nombre_cliente'];\n\nfor (const campo of camposTexto) {\n  if (datosUsuario[campo] && caracteresInvalidos.test(datosUsuario[campo])) {\n    console.log(`‚ö†Ô∏è Campo ${campo} contiene caracteres inv√°lidos: \"${datosUsuario[campo]}\". Marcando como null.`);\n    datosUsuario[`_original_${campo}`] = datosUsuario[campo]; // Guardar original para debug\n    datosUsuario[campo] = null; // La IA detectar√° que falta\n  }\n  \n  // Tambi√©n detectar si empieza con / (comando)\n  if (datosUsuario[campo] && datosUsuario[campo].startsWith('/')) {\n    console.log(`‚ö†Ô∏è Campo ${campo} parece un comando: \"${datosUsuario[campo]}\". Marcando como null.`);\n    datosUsuario[`_original_${campo}`] = datosUsuario[campo];\n    datosUsuario[campo] = null;\n  }\n}\n\n\n// Parsear respuesta de Gemini si es string\nlet validacion;\ntry {\n  validacion = typeof respuestaGemini === 'string' \n    ? JSON.parse(respuestaGemini.replace(/```json|```/g, '').trim())\n    : respuestaGemini;\n} catch (e) {\n  console.error('Error parseando respuesta de Gemini:', e);\n  // Fallback: asumir que hay error y escalar\n  validacion = {\n    valido: false,\n    campo_faltante: null,\n    pregunta_usuario: null,\n    errores: ['Error procesando validaci√≥n de IA']\n  };\n}\n\n// Determinar acci√≥n\nlet action = 'send_to_central';\nlet next_step = 'completado';\nlet text = 'üéâ ¬°Excelente! Tu solicitud ha sido enviada.\\n\\nTe hemos enviado un correo de confirmaci√≥n.';\n\nif (!validacion.valido) {\n  // Guardar errores encontrados por la IA para tracking\n  datosUsuario._errores_ia = validacion.errores || [];\n  \n  if (validacion.campo_faltante && validacion.pregunta_usuario) {\n    // Hay un campo faltante, preguntar al usuario\n    action = 'ask_field';\n    next_step = 'validacion_ia';\n    text = validacion.pregunta_usuario;\n    datosUsuario._campo_pendiente = validacion.campo_faltante;\n    console.log(`‚ùå Campo faltante: ${validacion.campo_faltante}`);\n  } else {\n    // Error sin campo espec√≠fico, escalar\n    action = 'send_to_error_support';\n    next_step = 'start';\n    text = '‚ö†Ô∏è Hubo un problema validando tus datos. Un representante te contactar√° pronto.';\n    console.log('‚ö†Ô∏è Error sin campo espec√≠fico, escalando a soporte');\n  }\n} else {\n  // Validaci√≥n exitosa - limpiar campos temporales\n  delete datosUsuario._campo_pendiente;\n  delete datosUsuario._errores_ia;\n  datosUsuario.tipoValidacion = 'IA'; // Marcar que pas√≥ por validaci√≥n IA\n  console.log('‚úÖ Validaci√≥n exitosa, limpiando campos temporales');\n}\n\nreturn {\n  // Datos para el siguiente nodo\n  validacion_result: validacion,\n  action: action,\n  next_step: next_step,\n  text: text,\n  update_data: datosUsuario,\n  origen: origen,\n  \n  // Metadata\n  _debug: {\n    respuesta_gemini_raw: respuestaGemini,\n    timestamp: new Date().toISOString()\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2128,
        -16
      ],
      "id": "95db7ff9-a619-4d2f-9488-a1f148fdff63",
      "name": " validadorIA"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ============================================\n * NODO: adaptarDatosTelegram\n * ============================================\n * \n * PROP√ìSITO:\n * Convierte los datos del flujo de Telegram al formato esperado\n * por el flujo web (calcularDias, clasificarUrgencia, etc.)\n * \n * INPUT (desde switchValidacionIA -> Merge):\n * - update_data: Objeto con datos del usuario en formato Telegram\n *   - fecha_evento: \"DD/MM/YYYY\"\n * \n * OUTPUT:\n * - body: Objeto con datos en formato web\n *   - fecha_evento: \"YYYY-MM-DD\"\n * \n * UBICACI√ìN EN FLUJO:\n * switchValidacionIA (send_to_central) ‚Üí adaptarDatosTelegram ‚Üí Merge ‚Üí calcularDias\n * \n * AUTOR: Live Moments Team\n * √öLTIMA ACTUALIZACI√ìN: 2025-12-09\n */\n\n// ============================================\n// FUNCIONES AUXILIARES\n// ============================================\n\n/**\n * Convierte fecha de DD/MM/YYYY a YYYY-MM-DD\n * @param {string} fechaDDMMYYYY - Fecha en formato \"DD/MM/YYYY\"\n * @returns {string} Fecha en formato \"YYYY-MM-DD\" o null si inv√°lida\n */\nfunction convertirFechaAISO(fechaDDMMYYYY) {\n  if (!fechaDDMMYYYY || typeof fechaDDMMYYYY !== 'string') {\n    console.warn('‚ö†Ô∏è Fecha vac√≠a o no es string:', fechaDDMMYYYY);\n    return null;\n  }\n  \n  // Si ya est√° en formato ISO (YYYY-MM-DD), retornar tal cual\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(fechaDDMMYYYY)) {\n    console.log('üìÖ Fecha ya est√° en formato ISO:', fechaDDMMYYYY);\n    return fechaDDMMYYYY;\n  }\n  \n  // Convertir DD/MM/YYYY a YYYY-MM-DD\n  const partes = fechaDDMMYYYY.split('/');\n  if (partes.length !== 3) {\n    console.warn('‚ö†Ô∏è Formato de fecha no reconocido:', fechaDDMMYYYY);\n    return fechaDDMMYYYY; // Retornar original si no se puede parsear\n  }\n  \n  const [dia, mes, anio] = partes;\n  const fechaISO = `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;\n  \n  console.log(`üìÖ Fecha convertida: ${fechaDDMMYYYY} ‚Üí ${fechaISO}`);\n  return fechaISO;\n}\n\n/**\n * Limpia el n√∫mero de tel√©fono a solo d√≠gitos con c√≥digo de pa√≠s\n * @param {string} telefono - Tel√©fono en cualquier formato\n * @returns {string} Tel√©fono limpio\n */\nfunction limpiarTelefono(telefono) {\n  if (!telefono) return '';\n  // Mantener el + si existe, eliminar todo lo dem√°s que no sea d√≠gito\n  const limpio = telefono.replace(/[^\\d+]/g, '');\n  return limpio;\n}\n\n// ============================================\n// L√ìGICA PRINCIPAL\n// ============================================\n\nconst input = $input.item.json;\n\n// Los datos vienen en update_data desde el flujo de Telegram\nconst datos = input.update_data || input;\n\n// Validar que tenemos datos\nif (!datos || Object.keys(datos).length === 0) {\n  throw new Error('No se recibieron datos para adaptar');\n}\n\nconsole.log('üîÑ Adaptando datos de Telegram a formato web...');\nconsole.log('üìä Datos originales:', JSON.stringify(datos, null, 2));\n\n// Crear objeto en formato compatible con el flujo web\n// El flujo web espera los datos dentro de un objeto \"body\"\nconst datosAdaptados = {\n  body: {\n    // Datos del evento\n    tipo_evento: datos.tipo_evento || null,\n    fecha_evento: convertirFechaAISO(datos.fecha_evento),\n    ubicacion_evento: datos.ubicacion_evento || null,\n    duracion_estimada: datos.duracion_estimada || 'No especificada',\n    tiene_internet_venue: datos.tiene_internet_venue || 'No especificado',\n    \n    // Datos del paquete\n    paquete_interes: datos.paquete_interes || null,\n    add_ons_solicitados: datos.add_ons_solicitados || [],\n    \n    // Datos del cliente\n    nombre_cliente: datos.nombre_cliente || null,\n    email_cliente: datos.email_cliente || null,\n    telefono_cliente: limpiarTelefono(datos.telefono_cliente),\n    \n    // Comentarios\n    comentarios_adicionales: datos.comentarios_adicionales || '',\n    \n    // Metadata de origen (para tracking)\n    origen: datos.origen || 'telegram',\n    tipoValidacion: datos.tipoValidacion || 'IA',\n    \n    // Campos adicionales que podr√≠an venir del bot\n    revision_manual: datos.revision_manual || false\n  }\n};\n\n// Validar campos cr√≠ticos\nconst camposCriticos = ['tipo_evento', 'fecha_evento', 'nombre_cliente', 'email_cliente'];\nconst camposFaltantes = camposCriticos.filter(campo => !datosAdaptados.body[campo]);\n\nif (camposFaltantes.length > 0) {\n  console.warn(`‚ö†Ô∏è Campos cr√≠ticos faltantes: ${camposFaltantes.join(', ')}`);\n}\n\nconsole.log('‚úÖ Datos adaptados:', JSON.stringify(datosAdaptados, null, 2));\n\nreturn datosAdaptados;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        16
      ],
      "id": "3699023f-e648-4733-b362-b27fdd9b3b60",
      "name": "adaptarDatosTelegram"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Configuracion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "calcularDias": {
      "main": [
        [
          {
            "node": "clasificarUrgencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "clasificarUrgencia": {
      "main": [
        [
          {
            "node": "validarDatos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validarDatos": {
      "main": [
        [
          {
            "node": "formularioValido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formularioValido": {
      "main": [
        [
          {
            "node": "existenDatosValidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "registroErrores": {
      "main": [
        [
          {
            "node": "responderCode400",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "procesarRespuesta": {
      "main": [
        [
          {
            "node": "correoConfirmacionCliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "correoErrorSoporte": {
      "main": [
        [
          {
            "node": "registroErrores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "correoConfirmacionCliente": {
      "main": [
        [
          {
            "node": "resgitroExitoso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resgitroExitoso": {
      "main": [
        [
          {
            "node": "enviarExitosoTelegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setEmailGen√©rico": {
      "main": [
        [
          {
            "node": "procesarEmailGenerico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "procesarEmailGenerico": {
      "main": [
        [
          {
            "node": "correoConfirmacionCliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øIA Exitosa?": {
      "main": [
        [
          {
            "node": "procesarRespuesta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "setEmailGen√©rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuracion": {
      "main": [
        [
          {
            "node": "fomularioWeb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "generadorCorreoIA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "generadorCorreoIA",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "enviarExitosoTelegram": {
      "main": [
        [
          {
            "node": "responderCode200",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "telegramTrigger": {
      "main": [
        [
          {
            "node": "buscarSesion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "buscarSesion": {
      "main": [
        [
          {
            "node": "esNuevoUsuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "logicaBot": {
      "main": [
        [
          {
            "node": "switchAccion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "esNuevoUsuario": {
      "main": [
        [
          {
            "node": "crearSesion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "esValidacionIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crearSesion": {
      "main": [
        [
          {
            "node": "logicaBot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "capaValidadorIA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "switchAccion": {
      "main": [
        [
          {
            "node": "capaValidadorIA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "HTTP_Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "actualizarSesion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "correoErrorSoporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "esValidacionIA": {
      "main": [
        [
          {
            "node": "prepararDatosIA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "logicaBot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepararDatosIA": {
      "main": [
        [
          {
            "node": "capaValidadorIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "calcularDias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validarDatosIA": {
      "main": [
        [
          {
            "node": "switchValidacionIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "switchValidacionIA": {
      "main": [
        [
          {
            "node": "actualizarSesion",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP_Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "adaptarDatosTelegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "actualizarSesion",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP_Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "correoErrorSoporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "existenDatosValidos": {
      "main": [
        [
          {
            "node": "generadorCorreoIA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "correoErrorSoporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "capaValidadorIA": {
      "main": [
        [
          {
            "node": " validadorIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generadorCorreoIA": {
      "main": [
        [
          {
            "node": "¬øIA Exitosa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " validadorIA": {
      "main": [
        [
          {
            "node": "validarDatosIA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "adaptarDatosTelegram": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "2106d9b4-3340-4bbb-b121-49322e8a85a9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8db62e2bea7e0e9ff91c93d0f536bbe0241ad88a0b3e2e28d80d2ab1809fb308"
  },
  "id": "2y9CdSGpIMuXtBB4",
  "tags": []
}